<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Edge of Eternities — Play Booster List (EOE + EoE:SS + SG + TOK)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  /* All styles scoped under .eoe-app */
  .eoe-app {
    --bg:#0b0d10; --fg:#e8ecf1; --muted:#a7b0bb; --acc:#6ac1ff;
    --card:#151a20; --ok:#1e7f3c; --okbg:rgba(30,127,60,.20);
    --err:#9b2c2c; --errbg:rgba(155,44,44,.16);
    min-height:100vh; background:var(--bg); color:var(--fg);
    font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    max-width:1100px; margin:32px auto; padding:0 16px; box-sizing:border-box;
  }
  .eoe-app a{ color:var(--acc); text-decoration:underline }
  .eoe-app h1{font-size:22px;margin:0 0 12px}
  .eoe-app p.lede{color:var(--muted);margin:0 0 16px}
  .eoe-app .panel{background:var(--card);border:1px solid #222a33;border-radius:10px;padding:16px;margin:16px 0}
  .eoe-app label{display:block;margin:4px 0}
  .eoe-app .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  .eoe-app input[type="number"], .eoe-app input[type="text"]{
    width:10ch;background:#0e1216;color:#cfe3f5;border:1px solid #2a3541;border-radius:6px;padding:6px
  }
  .eoe-app button{appearance:none;border:1px solid #2c3845;background:#1b232c;color:var(--fg);padding:10px 14px;border-radius:8px;cursor:pointer}
  .eoe-app button[disabled]{opacity:.5;cursor:default}
  .eoe-app .actions{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 0}
  .eoe-app #status{margin-top:8px;color:var(--muted)}
  .eoe-app #counts b{color:#7ddc7a}
  .eoe-app textarea{width:100%;min-height:260px;background:#0e1216;color:#cfe3f5;border:1px solid #2a3541;border-radius:8px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;box-sizing:border-box}
  .eoe-app details{margin-top:8px}
  .eoe-app summary{cursor:pointer;color:var(--acc)}
  .eoe-app footer{margin-top:16px;color:var(--muted);font-size:12px}
  .eoe-app code{background:#0e1216;border:1px solid #2a3541;padding:1px 4px;border-radius:4px}

  /* Error panel */
  .eoe-app .error-panel{border-color:#ff7a7a!important}
  .eoe-app .error-panel h2{margin:0 0 8px; color:#ff7a7a; font-size:16px}
  .eoe-app .error-panel pre{white-space:pre-wrap; background:#0e1216; border:1px solid #2a3541; padding:8px; border-radius:6px; color:#ffd4d4}
  .eoe-app .error-panel a{color:#ffb3b3; text-decoration:underline}

  /* Tables */
  .eoe-app table{width:100%; border-collapse:collapse; margin-top:8px}
  .eoe-app th,.eoe-app td{border:1px solid #2a3541; padding:6px 8px; text-align:right}
  .eoe-app th:first-child,.eoe-app td:first-child{text-align:left}
  .eoe-app thead th{background:#0e1216; position:sticky; top:0; z-index:1}
  .eoe-app tbody tr:nth-child(even){background:#12171d}

  .sift-tablewrap{max-height:520px; overflow:auto; border:1px solid #2a3541; border-radius:8px; margin-top:8px}
  .sift-ok{background:var(--okbg)!important}
  .sift-bad{background:var(--errbg)!important}
  .sift-legend{display:flex; gap:12px; align-items:center; font-size:12px; color:var(--muted)}
  .pill{display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #2a3541}
  .pill.ok{background:var(--okbg); color:#d9ffe3; border-color:var(--ok)}
  .pill.bad{background:var(--errbg); color:#ffdede; border-color:var(--err)}

  /* Small EV table under Sift */
  .evbox{margin-top:8px}
  .evbox table{width:auto; min-width:360px}
  .evbox th,.evbox td{text-align:right}
  .evbox th:first-child,.evbox td:first-child{text-align:left;white-space:nowrap}
</style>
</head>
<body>
<main class="eoe-app" role="main" aria-label="Edge of Eternities — Play Booster List builder">
  <h1>Edge of Eternities — Play Booster List (EOE + EoE:SS + SG + TOK)</h1>
  <p class="lede">
    Builds a single CSV of everything that can appear in an <strong>Edge of Eternities</strong> Play Booster.<br/>
    Columns: <code>Set, Number, Rarity, Name, Treatment, Pack Prob Min (%), Pack Prob Max (%), Card Value (USD), Per 1000 Min, Per 1000 Max, Per 30000 Min, Per 30000 Max, Per 300000 Min, Per 300000 Max</code>.
  </p>

  <div class="panel">
    <strong>Options</strong>
    <label><input type="checkbox" id="englishOnly" checked> English-only (avoid duplicate rows for other languages)</label>
    <label><input type="checkbox" id="includeEOE" checked> Include <strong>EOE</strong> (1–316; default + Play‑eligible borderless)</label>
    <label><input type="checkbox" id="includeEOS" checked> Include <strong>EoE:SS</strong> (Stellar Sights 1–45; exclude galaxy/etched)</label>
    <label><input type="checkbox" id="includeSPG" checked> Include <strong>SG</strong> (Special Guests 119–128; nonfoil only)</label>
    <div class="row">
      <label><input type="checkbox" id="includeTOK" checked> Include <strong>TOK</strong> (Play‑Booster tokens & emblem from <code>TEOE</code>)</label>
      <label>Token pool size:
        <input type="number" id="tokenPool" value="11" min="1" step="1" aria-label="Token pool size">
      </label>
      <label>Token fallback (USD):
        <input type="text" id="tokenFallback" value="0.05" aria-label="Token fallback USD">
      </label>
    </div>

    <div class="actions">
      <button id="buildBtn">Build list</button>
      <button id="downloadCsv" disabled>Download CSV</button>
      <button id="copyCsv" disabled>Copy CSV</button>
      <button id="sum300k" disabled>Sum Per 300k</button>
      <button id="evPerBox300k" disabled>EV/Box @ 300k</button>
    </div>
    <div id="status" aria-live="polite">Ready.</div>
    <div id="counts"></div>
  </div>

  <div id="errorBox" class="panel error-panel" style="display:none">
    <h2>Load failed</h2>
    <div id="errorMsg"></div>
    <pre id="errorDetails"></pre>
    <div id="errorLinks"></div>
  </div>

  <div id="totalsPanel" class="panel totals" style="display:none">
    <h2>Totals @ 300,000 packs</h2>
    <div class="note">
      Columns show Low / Est. (midpoint) / High. Pack totals follow the official model: <strong>14 Magic cards + 1 token</strong> per pack.<br>
      <em>Note:</em> Playing‑card probabilities are <strong>normalized</strong> so the per‑pack EST sums to 14. Tokens are not normalized.
    </div>
    <table>
      <thead><tr><th>Metric</th><th>Low</th><th>Est.</th><th>High</th></tr></thead>
      <tbody id="totalsBody"></tbody>
    </table>
    <div id="totalsNotes" class="note"></div>
  </div>

  <!-- Sift panel -->
  <div id="siftPanel" class="panel" style="display:none">
    <strong>Sift by Card Value (USD)</strong>
    <div class="row">
      <label>Minimum Card Value (USD):
        <!-- Default threshold -->
        <input type="text" id="siftMin" value="0.25" aria-label="Sift minimum USD">
      </label>
      <button id="applySift" disabled>Apply Sift</button>
      <button id="downloadSiftCsv" disabled>Download Sift Table</button>
      <span class="sift-legend">
        <span class="pill ok">≥ threshold</span>
        <span class="pill bad">&lt; threshold</span>
      </span>
    </div>
    <div id="siftSummary" class="note" aria-live="polite"></div>
    <!-- NEW: compact EV table -->
    <div id="siftEVContainer" class="evbox" style="display:none"></div>

    <div class="sift-tablewrap" id="siftTableWrap" style="display:none">
      <table id="siftTable">
        <thead>
          <tr>
            <th>Set</th><th>No.</th><th>R</th><th>Name</th><th>Treat</th>
            <th>Pack Prob Min (%)</th><th>Pack Prob Max (%)</th><th>Card Value (USD)</th>
            <th>Per 1000 Min</th><th>Per 1000 Max</th>
            <th>Per 30000 Min</th><th>Per 30000 Max</th>
            <th>Per 300000 Min</th><th>Per 300000 Max</th>
          </tr>
        </thead>
        <tbody id="siftBody"></tbody>
      </table>
    </div>
  </div>

  <div class="panel">
    <strong>CSV preview</strong>
    <textarea id="preview" placeholder="Your CSV will appear after you click ‘Build list’…"></textarea>
    <details>
      <summary>Advanced: see the exact Scryfall queries</summary>
      <pre id="queries" style="white-space:pre-wrap;"></pre>
    </details>
  </div>

  <footer>
    Tokens/emblem are taken from the TEOE token set; Punchcard and art‑series prints are excluded.
    Token/emblem prices use Scryfall’s per‑print USD; if missing, the fallback above is applied only to tokens/emblem.
  </footer>
</main>

<script>
  /* ---------- helpers ---------- */
  const rarityLetter = r => ({ common:'C', uncommon:'U', rare:'R', mythic:'M' }[r] || (r ? r[0].toUpperCase() : ''));
  const sleep = ms => new Promise(res => setTimeout(res, ms));
  function padCollector(numStr){ const m=String(numStr||'').match(/^(\d+)(.*)$/); return m?m[1].padStart(4,'0')+(m[2]||''): (numStr||''); }
  function baseCN(numStr){ const m=String(numStr||'').match(/^(\d+)/); return m?parseInt(m[1],10):NaN; }
  function priceUSD(card, treatment){ const p = (treatment==='foil'? card?.prices?.usd_foil : card?.prices?.usd); const f=parseFloat(p); return Number.isFinite(f)? f : null; }
  function parseUSD(str){ const n=parseFloat(String(str).replace(/[^0-9.]/g,'')); return Number.isFinite(n)? n : null; }
  function money(n){ return Number.isFinite(n) ? n.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) : ''; }
  function fmtUSD(n){ return money(n); }
  function fmtCount(n){
    if(!Number.isFinite(n)) return '';
    const isInt = Math.abs(n - Math.round(n)) < 1e-9;
    if(isInt) return String(Math.round(n));
    if(n >= 100) return n.toFixed(1);
    if(n >= 10)  return n.toFixed(2);
    return n.toFixed(3);
  }
  function fmtInt(n){ return Number.isFinite(n)? Math.round(n).toLocaleString() : ''; }
  function fmtPct5(x){ return Number.isFinite(x) ? (x*100).toFixed(5) + '%' : ''; }

  /* ---------- EOE Play Booster odds (per pack) ---------- */
  const ODDS = {
    // 7 commons base + 12.5% wildcard common − 1.8% SPG replace
    E_COMMON_SLOTS: 7 + 0.125 - 0.018,
    E_UNCOMMON_SLOTS: 3 + 0.625,
    N_COMMONS: 81, N_UNCOMMONS: 100, N_RARES: 60, N_MYTHICS: 20,

    WC_MAINSET_RARE: 0.106,
    WC_MAINSET_MYTHIC_LT: 0.01,
    WC_EOS_RARE: 0.10, WC_EOS_MYTHIC: 0.025,
    WC_VIEWPORT_RARE: 0.01, WC_VIEWPORT_MYTHIC_LT: 0.01,
    WC_TRISUR_RARE_LT: 0.01, WC_TRISUR_MYTHIC_LT: 0.01,

    RS_MAINSET_RARE: 0.804, RS_MAINSET_MYTHIC: 0.142,
    RS_TRI_RARE: 0.02, RS_TRI_MYTHIC_LT: 0.01,
    RS_SURR_RARE: 0.02, RS_SURR_MYTHIC_LT: 0.01,
    RS_VIEWPORT_MYTHIC_LT: 0.01,

    FOIL_MAINSET_C: 0.58, FOIL_MAINSET_U: 0.32, FOIL_MAINSET_R: 0.064, FOIL_MAINSET_M: 0.011,
    FOIL_EOS_RARE: 0.01, FOIL_EOS_MYTHIC_LT: 0.01,
    FOIL_BORDERLESS_RARE_LT: 0.01, FOIL_BORDERLESS_MYTHIC_LT: 0.01,

    LAND_DEFAULT_NF: 0.64, LAND_DEFAULT_F: 0.16,
    LAND_CELESTIAL_NF: 0.16, LAND_CELESTIAL_F: 0.04,

    SPG_ANY: 0.018
  };

  const FAM = {
    TRI_RARE: 12, TRI_MYTHIC: 4,
    SURR_RARE: 11, SURR_MYTHIC: 3,
    VIEW_RARE: 5, VIEW_MYTHIC: 5,
    EOS_RARE: 30, EOS_MYTHIC: 15,
    BASIC_DEFAULT: 10, BASIC_CELESTIAL: 5,
    SPG: 10
  };
  FAM.BORDERLESS_RARE = FAM.TRI_RARE + FAM.SURR_RARE + FAM.VIEW_RARE;        // 28
  FAM.BORDERLESS_MYTHIC = FAM.TRI_MYTHIC + FAM.SURR_MYTHIC + FAM.VIEW_MYTHIC; // 12

  /* ---------- probability / counting (with normalization) ---------- */
  function countFromModelRaw(model, packs){
    if(!model) return null;
    if(model.type==='point') return { lo:model.p*packs, est:model.p*packs, hi:model.p*packs, max:model.p*packs };
    if(model.type==='range') return { lo:model.lo*packs, est:((model.lo+model.hi)/2)*packs, hi:model.hi*packs, max:model.hi*packs };
    if(model.type==='max')   return { lo:0, est:(model.max/2)*packs, hi:model.max*packs, max:model.max*packs };
    return null;
  }
  function probMinMaxRaw(model){
    if(!model) return {min:null, max:null};
    if(model.type==='point') return {min:model.p, max:model.p};
    if(model.type==='range') return {min:model.lo, max:model.hi};
    if(model.type==='max')   return {min:0, max:model.max};
    return {min:null, max:null};
  }

  // Global normalization factor (applies to playing cards only; tokens unaffected)
  let __NORM_SCALE__ = 1;

  function countFromModel(model, packs, isToken=false, useScaled=true){
    const c = countFromModelRaw(model, packs);
    if(!c || isToken || !useScaled) return c;
    return { lo:c.lo*__NORM_SCALE__, est:c.est*__NORM_SCALE__, hi:c.hi*__NORM_SCALE__, max:c.max*__NORM_SCALE__ };
  }
  function probMinMaxScaled(model, isToken=false, useScaled=true){
    const {min, max} = probMinMaxRaw(model);
    if(min==null || isToken || !useScaled) return {min, max};
    return { min: min*__NORM_SCALE__, max: max*__NORM_SCALE__ };
  }

  function classifyEOE(cnBase){
    if(cnBase>=262 && cnBase<=266) return 'CELESTIAL_BASIC';
    if(cnBase>=267 && cnBase<=276) return 'DEFAULT_BASIC';
    if(cnBase>=277 && cnBase<=286) return 'VIEWPORT';
    if(cnBase>=287 && cnBase<=316) return 'TRISUR';
    return 'DEFAULT_FRAME';
  }

  // Probability model per row (print + treatment)
  let __TOKEN_POOL__ = 11; // set from UI

  function probModel({ set, cnBase, rarity, treatment }){
    if(set==='TOK'){ // Tokens/emblem: equal share
      if(treatment!=='normal') return null;
      return { type:'point', p: 1 / Math.max(1,__TOKEN_POOL__) };
    }
    if(set==='SG'){ // Special Guests (nonfoil only)
      if(treatment!=='normal') return null;
      return { type:'point', p: ODDS.SPG_ANY / FAM.SPG };
    }
    if(set==='EoE:SS'){ // Stellar Sights
      if(rarity==='R'){
        return (treatment==='normal') ? { type:'point', p: ODDS.WC_EOS_RARE / FAM.EOS_RARE }
                                      : { type:'point', p: ODDS.FOIL_EOS_RARE / FAM.EOS_RARE };
      } else if(rarity==='M'){
        return (treatment==='normal') ? { type:'point', p: ODDS.WC_EOS_MYTHIC / FAM.EOS_MYTHIC }
                                      : { type:'max',   max: ODDS.FOIL_EOS_MYTHIC_LT / FAM.EOS_MYTHIC };
      }
      return null;
    }
    if(set==='EOE'){ // Main set
      const fam = classifyEOE(cnBase);

      if(fam==='DEFAULT_BASIC'){
        return (treatment==='normal') ? { type:'point', p: ODDS.LAND_DEFAULT_NF / FAM.BASIC_DEFAULT }
                                      : { type:'point', p: ODDS.LAND_DEFAULT_F  / FAM.BASIC_DEFAULT };
      }
      if(fam==='CELESTIAL_BASIC'){
        return (treatment==='normal') ? { type:'point', p: ODDS.LAND_CELESTIAL_NF / FAM.BASIC_CELESTIAL }
                                      : { type:'point', p: ODDS.LAND_CELESTIAL_F  / FAM.BASIC_CELESTIAL };
      }
      if(fam==='VIEWPORT'){ // borderless lands
        if(rarity==='R'){
          return (treatment==='normal') ? { type:'point', p: ODDS.WC_VIEWPORT_RARE / FAM.VIEW_RARE }
                                        : { type:'max',   max: ODDS.FOIL_BORDERLESS_RARE_LT / FAM.BORDERLESS_RARE };
        } else if(rarity==='M'){
          if(treatment==='normal'){
            const ub = (ODDS.WC_VIEWPORT_MYTHIC_LT + ODDS.RS_VIEWPORT_MYTHIC_LT) / FAM.VIEW_MYTHIC;
            return { type:'max', max: ub };
          } else {
            return { type:'max', max: ODDS.FOIL_BORDERLESS_MYTHIC_LT / FAM.BORDERLESS_MYTHIC };
          }
        }
      }
      if(fam==='TRISUR'){ // Triumphant / Surreal (borderless)
        if(rarity==='R'){
          if(treatment==='normal'){
            const base = (ODDS.RS_TRI_RARE + ODDS.RS_SURR_RARE) / (FAM.TRI_RARE + FAM.SURR_RARE);
            const hi   = base + (ODDS.WC_TRISUR_RARE_LT / (FAM.TRI_RARE + FAM.SURR_RARE));
            return { type:'range', lo: base, hi: hi };
          } else {
            return { type:'max', max: ODDS.FOIL_BORDERLESS_RARE_LT / FAM.BORDERLESS_RARE };
          }
        } else if(rarity==='M'){
          if(treatment==='normal'){
            const ub = (ODDS.RS_TRI_MYTHIC_LT + ODDS.RS_SURR_MYTHIC_LT + ODDS.WC_TRISUR_MYTHIC_LT) / (FAM.TRI_MYTHIC + FAM.SURR_MYTHIC);
            return { type:'max', max: ub };
          } else {
            return { type:'max', max: ODDS.FOIL_BORDERLESS_MYTHIC_LT / FAM.BORDERLESS_MYTHIC };
          }
        }
      }

      // Default-frame EOE (non-basic)
      if(rarity==='C'){
        return (treatment==='normal') ? { type:'point', p: ODDS.E_COMMON_SLOTS / ODDS.N_COMMONS }
                                      : { type:'point', p: ODDS.FOIL_MAINSET_C / ODDS.N_COMMONS };
      } else if(rarity==='U'){
        return (treatment==='normal') ? { type:'point', p: ODDS.E_UNCOMMON_SLOTS / ODDS.N_UNCOMMONS }
                                      : { type:'point', p: ODDS.FOIL_MAINSET_U / ODDS.N_UNCOMMONS };
      } else if(rarity==='R'){
        return (treatment==='normal') ? { type:'point', p: (ODDS.RS_MAINSET_RARE + ODDS.WC_MAINSET_RARE) / ODDS.N_RARES }
                                      : { type:'point', p: ODDS.FOIL_MAINSET_R / ODDS.N_RARES };
      } else if(rarity==='M'){
        if(treatment==='normal'){
          const lo = (ODDS.RS_MAINSET_MYTHIC) / ODDS.N_MYTHICS;
          const hi = (ODDS.RS_MAINSET_MYTHIC + ODDS.WC_MAINSET_MYTHIC_LT) / ODDS.N_MYTHICS;
          return { type:'range', lo, hi };
        } else {
          return { type:'point', p: ODDS.FOIL_MAINSET_M / ODDS.N_MYTHICS };
        }
      }
    }
    return null;
  }

  /* ---------- Scryfall query builder ---------- */
  function buildQuery(setCode, englishOnly){
    let q = '';
    if(setCode==='EOE'){ q = 'e:eoe is:booster cn<=316 -finish:glossy -finish:etched'; }
    else if(setCode==='EOS'){ q = 'e:eos cn<=45 -finish:glossy -finish:etched'; }
    else if(setCode==='SPG'){ q = 'e:spg cn>=119 cn<=128'; }
    else if(setCode==='TOK'){ q = 'e:teoe (layout:token or layout:double_faced_token or layout:emblem) -layout:art_series -name:"Punchcard"'; }
    if(englishOnly) q += ' lang:en';
    return q;
  }

  /* ---------- Scryfall fetch (strict) ---------- */
  async function fetchAllPages(q, setLabel, statusEl){
    const base = 'https://api.scryfall.com/cards/search?unique=prints&order=set&dir=asc&q=';
    let url = base + encodeURIComponent(q);
    let out = [], page = 1;
    while(url){
      statusEl.textContent = `Fetching ${setLabel}: page ${page}…`;
      let resp;
      try { resp = await fetch(url); }
      catch (netErr) { throw { set:setLabel, query:q, status:'NETWORK', details:(netErr&&netErr.message)?netErr.message:String(netErr) }; }
      if(!resp.ok){
        const text = await resp.text().catch(()=> '');
        throw { set:setLabel, query:q, status:resp.status, details:text };
      }
      const json = await resp.json();
      out = out.concat(json.data || []);
      url = json.has_more ? json.next_page : null;
      page++;
      if(url) await sleep(120); // be polite
    }
    return out;
  }

  /* ---------- Collect rows (two-pass build) ---------- */
  let __ROW_MODELS__ = [];  // for aggregation/normalization (price, isToken, model)
  let __META_ROWS__ = [];   // minimal info to render CSV & Sift after normalization
  let __SIFT_CSV__ = '';    // last Sift CSV snapshot

  function rowsFromCards(cards, setTag, spgNonfoilOnly=false, isTokenSet=false, tokenFallback=null){
    for(const c of cards){
      const layout = c.layout || '';
      if(!isTokenSet && (layout.includes('token') || layout==='art_series' || layout==='emblem')) continue;

      if(isTokenSet){
        const nameLC = (c.name || '').toLowerCase();
        const isTokLayout = layout.includes('token');
        const isEmblem = layout === 'emblem';
        if(!(isTokLayout || isEmblem)) continue;
        if(nameLC.includes('punchcard')) continue;
      }

      const cn = padCollector(c.collector_number);
      const cnNum = baseCN(c.collector_number);
      if(!cn || (!isTokenSet && isNaN(cnNum))) continue;

      const finishes = Array.isArray(c.finishes) ? c.finishes : [];
      const rarity = isTokenSet ? (c.rarity ? rarityLetter(c.rarity) : 'C') : rarityLetter(c.rarity);
      const name = c.name;

      const pushOne = (treat) => {
        const model = probModel({ set:setTag, cnBase:cnNum, rarity, treatment:treat });
        if(!model) return;
        let val = priceUSD(c, treat);
        let usedFallback = false;
        if(isTokenSet && !Number.isFinite(val)){
          const tf = tokenFallback;
          if(Number.isFinite(tf)){ val = tf; usedFallback = true; }
        }
        __ROW_MODELS__.push({ model, price: val, isToken: isTokenSet, fallback: usedFallback });
        __META_ROWS__.push({
          setTag, cn, rarity, name, treatment:treat, model, price: val, isToken: isTokenSet,
          url: c.scryfall_uri || ''  // store Scryfall page URL for linking
        });
      };

      if(setTag==='SG' || spgNonfoilOnly){
        if(finishes.includes('nonfoil')) pushOne('normal');
        continue;
      }
      if(isTokenSet){ pushOne('normal'); continue; }
      if(finishes.includes('nonfoil')) pushOne('normal');
      if(finishes.includes('foil'))    pushOne('foil');
    }
  }

  function toCsv(rows){
    return rows.map(r => r.map(v => {
      const s = String(v ?? '');
      return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
    }).join(',')).join('\n');
  }

  function downloadCsv(filename, data){
    const blob = new Blob(["\uFEFF" + data], { type:'text/csv;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(a.href);
    a.remove();
  }

  function showErrorBox(err){
    const box = document.getElementById('errorBox');
    const msg = document.getElementById('errorMsg');
    const details = document.getElementById('errorDetails');
    const links = document.getElementById('errorLinks');

    const set = err && err.set ? err.set : 'Unknown set';
    const status = (err && err.status !== undefined) ? err.status : 'ERROR';
    const query = err && err.query ? err.query : '(no query captured)';
    const snippet = (err && err.details) ? String(err.details).slice(0, 800) : '(no details)';
    const scryfallLink = 'https://scryfall.com/search?q=' + encodeURIComponent(query);

    msg.innerHTML = `<strong>Set:</strong> ${set} &nbsp; <strong>Status:</strong> ${status}`;
    details.textContent = `Query:\n${query}\n\nResponse snippet:\n${snippet}`;
    links.innerHTML = `<a href="${scryfallLink}" target="_blank" rel="noopener noreferrer">Try this query on Scryfall</a>`;
    box.style.display = '';
  }

  /* ---------- Aggregation (scaled/unscaled) ---------- */
  function aggregateFor(packs, includeTokens = true, useScaled = true){
    let lowCount=0, estCount=0, highCount=0, lowEV=0, estEV=0, highEV=0, missingPrice=0, fallbackUsed=0;
    for(const row of (__ROW_MODELS__ || [])){
      const { model, price, isToken, fallback } = row;
      if(!includeTokens && isToken) continue;

      const cnt = countFromModel(model, packs, isToken, useScaled);
      if(!cnt) continue;

      lowCount  += cnt.lo;  estCount += cnt.est;  highCount += cnt.hi;

      if(Number.isFinite(price)){
        lowEV += price*cnt.lo;  estEV += price*cnt.est;  highEV += price*cnt.hi;
      } else {
        missingPrice++;
      }
      if(fallback) fallbackUsed++;
    }
    return { lowCount, estCount, highCount, lowEV, estEV, highEV, missingPrice, fallbackUsed };
  }

  /* ---------- Totals renderer ---------- */
  function renderTotalsTable(){
    const P = 300000;           // packs
    const PACKS_PER_BOX = 30;   // boxes
    const boxes = P / PACKS_PER_BOX;

    // Exact model: 14 + 1 token
    const exactPlayingCards = 14 * P;  // 4,200,000
    const exactTokens       = 1  * P;  //   300,000
    const exactTotalItems   = exactPlayingCards + exactTokens; // 4,500,000

    // Aggregates (scaled)
    const aggCardsOnly = aggregateFor(P, /*includeTokens=*/false, /*useScaled=*/true);
    const aggAll       = aggregateFor(P, /*includeTokens=*/true,  /*useScaled=*/true);

    const lowPerBox  = aggAll.lowEV  / boxes;
    const estPerBox  = aggAll.estEV  / boxes;
    const highPerBox = aggAll.highEV / boxes;

    const body = document.getElementById('totalsBody');
    body.innerHTML = `
      <tr><td>Total expected cards + tokens @ ${P.toLocaleString()} packs (exact, 14 cards + 1 token)</td>
          <td>${fmtInt(exactTotalItems)}</td>
          <td>${fmtInt(exactTotalItems)}</td>
          <td>${fmtInt(exactTotalItems)}</td></tr>
      <tr><td>…of which tokens (exact)</td>
          <td>${fmtInt(exactTokens)}</td>
          <td>${fmtInt(exactTokens)}</td>
          <td>${fmtInt(exactTokens)}</td></tr>
      <tr><td>…of which playing cards (exact)</td>
          <td>${fmtInt(exactPlayingCards)}</td>
          <td>${fmtInt(exactPlayingCards)}</td>
          <td>${fmtInt(exactPlayingCards)}</td></tr>
      <tr><td>Model‑check: sum across per‑print playing cards (normalized)</td>
          <td>${fmtInt(aggCardsOnly.lowCount)}</td>
          <td>${fmtInt(aggCardsOnly.estCount)}</td>
          <td>${fmtInt(aggCardsOnly.highCount)}</td></tr>
      <tr><td>Total EV across ${P.toLocaleString()} packs (incl. tokens)</td>
          <td>$${money(aggAll.lowEV)}</td>
          <td>$${money(aggAll.estEV)}</td>
          <td>$${money(aggAll.highEV)}</td></tr>
      <tr><td>EV per 30‑pack box (${boxes.toLocaleString()} boxes)</td>
          <td>$${money(lowPerBox)}</td>
          <td>$${money(estPerBox)}</td>
          <td>$${money(highPerBox)}</td></tr>
    `;

    const notes = [];
    if(aggAll.missingPrice > 0) notes.push(`${aggAll.missingPrice} rows had no USD price and were excluded from EV sums`);
    if(aggAll.fallbackUsed > 0) notes.push(`${aggAll.fallbackUsed} token/emblem rows used fallback token price (${document.getElementById('tokenFallback').value})`);
    notes.push('Playing‑card probabilities are normalized so the EST per pack sums to 14; tokens are not normalized.');
    notes.push('Pack totals locked to the official model: 14 Magic cards + 1 token per pack.');
    document.getElementById('totalsNotes').textContent = 'Notes: ' + notes.join('; ') + '.';

    document.getElementById('totalsPanel').style.display = '';
  }

  /* ---------- Sift core (render + aggregate + CSV snapshot) ---------- */
  function aggregateSift(packs, minUSD){
    let include=0, exclude=0, missingPrice=0, tokensIncluded=0;
    let lowEV=0, estEV=0, highEV=0;
    let lowCount=0, estCount=0, highCount=0;
    // priceSum kept internally in case needed later, but not displayed
    for(const row of (__ROW_MODELS__ || [])){
      const { model, price, isToken } = row;
      const ok = Number.isFinite(price) && price >= minUSD;
      if(ok){
        include++; if(isToken) tokensIncluded++;
        const cnt = countFromModel(model, packs, isToken, /*useScaled=*/true);
        if(cnt){
          lowCount += cnt.lo; estCount += cnt.est; highCount += cnt.hi;
          lowEV += price*cnt.lo; estEV += price*cnt.est; highEV += price*cnt.hi;
        }
      } else {
        exclude++;
        if(!Number.isFinite(price)) missingPrice++;
      }
    }
    return { include, exclude, tokensIncluded, lowCount, estCount, highCount, lowEV, estEV, highEV, missingPrice };
  }

  function renderSiftEVTable(agg, boxes){
    const lowPerBox  = agg.lowEV  / boxes;
    const estPerBox  = agg.estEV  / boxes;
    const highPerBox = agg.highEV / boxes;

    const evDiv = document.getElementById('siftEVContainer');
    evDiv.innerHTML = `
      <table>
        <thead>
          <tr><th>Metric</th><th>Low</th><th>Est.</th><th>High</th></tr>
        </thead>
        <tbody>
          <tr><td>EV across 300,000 packs</td><td>$${money(agg.lowEV)}</td><td>$${money(agg.estEV)}</td><td>$${money(agg.highEV)}</td></tr>
          <tr><td>EV per 30‑pack box</td><td>$${money(lowPerBox)}</td><td>$${money(estPerBox)}</td><td>$${money(highPerBox)}</td></tr>
        </tbody>
      </table>
    `;
    evDiv.style.display = '';
  }

  function renderSiftTable(minUSD){
    const P = 300000;
    const PACKS_PER_BOX = 30;
    const boxes = P / PACKS_PER_BOX;

    const body = document.getElementById('siftBody');
    body.innerHTML = '';

    for(const m of __META_ROWS__){
      const ok = Number.isFinite(m.price) && m.price >= minUSD;
      const cls = ok ? 'sift-ok' : 'sift-bad';
      const {min:pMin, max:pMax} = probMinMaxScaled(m.model, m.isToken, /*useScaled=*/true);
      const c1k   = countFromModel(m.model, 1000,    m.isToken, /*useScaled=*/true);
      const c30k  = countFromModel(m.model, 30000,   m.isToken, /*useScaled=*/true);
      const c300k = countFromModel(m.model, 300000,  m.isToken, /*useScaled=*/true);

      const tr = document.createElement('tr');
      tr.className = cls;

      // Build cells with a linked Name
      const cells = [
        m.setTag, m.cn, m.rarity, /* name link */, m.treatment,
        fmtPct5(pMin), fmtPct5(pMax), fmtUSD(m.price),
        fmtCount(c1k  ? c1k.lo   : NaN), fmtCount(c1k  ? c1k.hi   : NaN),
        fmtCount(c30k ? c30k.lo  : NaN), fmtCount(c30k ? c30k.hi  : NaN),
        fmtCount(c300k? c300k.lo : NaN), fmtCount(c300k? c300k.hi : NaN)
      ];

      // Set
      let td = document.createElement('td'); td.textContent = cells[0]; tr.appendChild(td);
      // No.
      td = document.createElement('td'); td.textContent = cells[1]; tr.appendChild(td);
      // Rarity
      td = document.createElement('td'); td.textContent = cells[2]; tr.appendChild(td);
      // Name (link)
      td = document.createElement('td');
      if(m.url){
        const a = document.createElement('a');
        a.href = m.url; a.target = '_blank'; a.rel = 'noopener noreferrer';
        a.textContent = m.name;
        td.appendChild(a);
      } else {
        td.textContent = m.name;
      }
      tr.appendChild(td);
      // Treatment
      td = document.createElement('td'); td.textContent = cells[4]; tr.appendChild(td);
      // Remaining numeric cells
      for(let i=5;i<cells.length;i++){
        const t = document.createElement('td'); t.textContent = cells[i]; tr.appendChild(t);
      }

      body.appendChild(tr);
    }

    const agg = aggregateSift(P, minUSD);

    // Sift summary: counts only (Hides “Sum of prices …” per request)
    const summary = document.getElementById('siftSummary');
    summary.innerHTML =
      `Sift ≥ <b>$${Number(minUSD).toFixed(2)}</b> — Included: <b>${agg.include.toLocaleString()}</b> ` +
      `(tokens: ${agg.tokensIncluded.toLocaleString()}) / Excluded: <b>${agg.exclude.toLocaleString()}</b> ` +
      `${agg.missingPrice? `(no USD on ${agg.missingPrice} rows)` : ''}`;

    // Render compact EV table
    renderSiftEVTable(agg, boxes);

    document.getElementById('siftTableWrap').style.display = '';
  }

  function applySift(minUSD){
    renderSiftTable(minUSD);
    // Build a CSV snapshot of the Sift table
    const header = ['Set','Number','Rarity','Name','Treatment','Pack Prob Min (%)','Pack Prob Max (%)','Card Value (USD)','Per 1000 Min','Per 1000 Max','Per 30000 Min','Per 30000 Max','Per 300000 Min','Per 300000 Max'];
    const rows = [];
    const tbody = document.getElementById('siftBody');
    for(const tr of tbody.querySelectorAll('tr')){
      const cols = Array.from(tr.querySelectorAll('td')).map(td => td.textContent);
      rows.push(cols);
    }
    __SIFT_CSV__ = toCsv([header, ...rows]);
    document.getElementById('downloadSiftCsv').disabled = false;
    document.getElementById('siftTableWrap').scrollIntoView({ behavior:'smooth', block:'start' });
  }

  /* ---------- Build flow (two-pass: collect → normalize → render) ---------- */
  async function build(){
    // Reset UI and state
    document.getElementById('errorBox').style.display = 'none';
    document.getElementById('totalsPanel').style.display = 'none';
    document.getElementById('siftPanel').style.display = 'none';
    document.getElementById('siftTableWrap').style.display = 'none';
    document.getElementById('siftEVContainer').style.display = 'none';
    document.getElementById('errorMsg').textContent = '';
    document.getElementById('errorDetails').textContent = '';
    document.getElementById('errorLinks').textContent = '';
    document.getElementById('totalsBody').textContent = '';
    document.getElementById('totalsNotes').textContent = '';
    document.getElementById('siftSummary').textContent = '';

    const englishOnly = document.getElementById('englishOnly').checked;
    const incEOE = document.getElementById('includeEOE').checked;
    const incEOS = document.getElementById('includeEOS').checked;
    const incSPG = document.getElementById('includeSPG').checked;
    const incTOK = document.getElementById('includeTOK').checked;
    __TOKEN_POOL__ = Math.max(1, parseInt(document.getElementById('tokenPool').value, 10) || 11);
    const tokenFallback = parseUSD(document.getElementById('tokenFallback').value);

    const status = document.getElementById('status');
    const counts = document.getElementById('counts');
    const preview = document.getElementById('preview');
    const queriesEl = document.getElementById('queries');

    const header = [
      'Set','Number','Rarity','Name','Treatment',
      'Pack Prob Min (%)','Pack Prob Max (%)','Card Value (USD)',
      'Per 1000 Min','Per 1000 Max','Per 30000 Min','Per 30000 Max','Per 300000 Min','Per 300000 Max'
    ];

    __ROW_MODELS__ = [];
    __META_ROWS__  = [];

    const queryList = [];
    if(incEOE) queryList.push(['EOE', buildQuery('EOE', englishOnly)]);
    if(incEOS) queryList.push(['EoE:SS', buildQuery('EOS', englishOnly)]);
    if(incSPG) queryList.push(['SG', buildQuery('SPG', englishOnly)]);
    if(incTOK) queryList.push(['TOK', buildQuery('TOK', englishOnly)]);
    queriesEl.textContent = queryList.map(([tag,q]) => `${tag}: ${q}`).join('\n');

    try {
      status.textContent = 'Starting…';
      const results = [];
      for(const [tag, q] of queryList){
        const cards = await fetchAllPages(q, tag, status);
        results.push([tag, cards]);
      }

      // PASS 1: collect models + meta
      for(const [tag, cards] of results){
        rowsFromCards(cards, tag, tag==='SG', tag==='TOK', tokenFallback);
      }

      // Normalize to 14 playing cards per pack (EST)
      const rawAggPerPack = aggregateFor(1, /*includeTokens=*/false, /*useScaled=*/false);
      __NORM_SCALE__ = (rawAggPerPack && rawAggPerPack.estCount) ? (14 / rawAggPerPack.estCount) : 1;

      // Sort meta before rendering
      __META_ROWS__.sort((a,b)=>{
        if(a.setTag!==b.setTag) return a.setTag.localeCompare(b.setTag);
        const pa=(a.cn||'').match(/^(\d+)(.*)$/)||[];
        const pb=(b.cn||'').match(/^(\d+)(.*)$/)||[];
        const na=pa[1]?parseInt(pa[1],10):0, nb=pb[1]?parseInt(pb[1],10):0;
        if(na!==nb) return na-nb;
        const sa=pa[2]||'', sb=pb[2]||'';
        if(sa!==sb) return sa.localeCompare(sb);
        if(a.name!==b.name) return a.name.localeCompare(b.name);
        return a.treatment.localeCompare(b.treatment);
      });

      // Build CSV from normalized models
      const allRows = __META_ROWS__.map(m => {
        const {min:pMin, max:pMax} = probMinMaxScaled(m.model, m.isToken, /*useScaled=*/true);
        const c1k   = countFromModel(m.model, 1000,    m.isToken, /*useScaled=*/true);
        const c30k  = countFromModel(m.model, 30000,   m.isToken, /*useScaled=*/true);
        const c300k = countFromModel(m.model, 300000,  m.isToken, /*useScaled=*/true);
        return [
          m.setTag, m.cn, m.rarity, m.name, m.treatment,
          fmtPct5(pMin), fmtPct5(pMax), fmtUSD(m.price),
          fmtCount(c1k  ? c1k.lo   : NaN), fmtCount(c1k  ? c1k.hi   : NaN),
          fmtCount(c30k ? c30k.lo  : NaN), fmtCount(c30k ? c30k.hi  : NaN),
          fmtCount(c300k? c300k.lo : NaN), fmtCount(c300k? c300k.hi : NaN)
        ];
      });

      const csv = toCsv([header, ...allRows]);
      window.__CSV__ = csv;
      preview.value = csv.slice(0, 300000);
      document.getElementById('downloadCsv').disabled = false;
      document.getElementById('copyCsv').disabled = false;
      document.getElementById('sum300k').disabled = false;
      document.getElementById('evPerBox300k').disabled = false;

      // Enable Sift panel & controls
      document.getElementById('siftPanel').style.display = '';
      document.getElementById('applySift').disabled = false;

      // AUTO‑APPLY SIFT at the default 0.25
      const minUSD = parseUSD(document.getElementById('siftMin').value);
      applySift(Number.isFinite(minUSD) ? minUSD : 0.25);

      // Counts
      const eoeCount = __META_ROWS__.filter(r => r.setTag==='EOE').length;
      const eosCount = __META_ROWS__.filter(r => r.setTag==='EoE:SS').length;
      const spgCount = __META_ROWS__.filter(r => r.setTag==='SG').length;
      const tokCount = __META_ROWS__.filter(r => r.setTag==='TOK').length;
      counts.innerHTML = `Built <b>${__META_ROWS__.length.toLocaleString()}</b> rows — EOE: <b>${eoeCount.toLocaleString()}</b>, EoE:SS: <b>${eosCount.toLocaleString()}</b>, SG: <b>${spgCount.toLocaleString()}</b>, TOK: <b>${tokCount.toLocaleString()}</b>.`;
      status.textContent = `Done. (Normalization factor: ${__NORM_SCALE__.toFixed(5)}; Sift auto‑applied at $${(Number.isFinite(minUSD)?minUSD:0.25).toFixed(2)})`;
    } catch(err){
      console.error(err);
      status.textContent = 'Error while building — see details below.';
      showErrorBox(err);
      document.getElementById('downloadCsv').disabled = true;
      document.getElementById('copyCsv').disabled = true;
      document.getElementById('sum300k').disabled = true;
      document.getElementById('evPerBox300k').disabled = true;
      document.getElementById('applySift').disabled = true;
      document.getElementById('downloadSiftCsv').disabled = true;
    }
  }

  /* ---------- Button hooks ---------- */
  document.getElementById('applySift').addEventListener('click', () => {
    const minUSD = parseUSD(document.getElementById('siftMin').value) ?? 0.25;
    applySift(minUSD);
  });

  document.getElementById('downloadSiftCsv').addEventListener('click', () => {
    if(__SIFT_CSV__) downloadCsv('EOE_PlayBooster_SiftTable.csv', __SIFT_CSV__);
  });

  document.getElementById('buildBtn').addEventListener('click', build);
  document.getElementById('downloadCsv').addEventListener('click', () => {
    if(window.__CSV__) downloadCsv('EOE_PlayBooster_List_Normalized.csv', window.__CSV__);
  });
  document.getElementById('copyCsv').addEventListener('click', async () => {
    if(!window.__CSV__) return;
    try { await navigator.clipboard.writeText(window.__CSV__); alert('CSV copied to clipboard.'); }
    catch { const t=document.getElementById('preview'); t.focus(); t.select(); alert('Select all (Ctrl/Cmd+A) and copy (Ctrl/Cmd+C).'); }
  });
  document.getElementById('sum300k').addEventListener('click', renderTotalsTable);
  document.getElementById('evPerBox300k').addEventListener('click', renderTotalsTable);
</script>
</body>
</html>
