<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Outlaws of Thunder Junction — Play Booster EV</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  html {background-color:#0b0d10;}
  /* App shell */
  .eoe-app{
    --bg:#0b0d10; --fg:#e8ecf1; --muted:#a7b0bb; --acc:#6ac1ff;
    --card:#151a20; --ok:#1e7f3c; --err:#9b2c2c; --line:#222a33;
    --hi-bg:rgba(106,193,255,.14); --hi-line:#6ac1ff;
    --est-bg:rgba(106,193,255,.18); --est-line:#6ac1ff;
    min-height:100vh;background:var(--bg);color:var(--fg);
    font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    max-width:1120px;margin:32px auto;padding:0 16px;box-sizing:border-box;
  }
  .eoe-app a{color:var(--acc);text-decoration:underline}
  .eoe-app h1{font-size:22px;margin:0 0 12px}
  .eoe-app p.lede{color:var(--muted);margin:0 0 16px}
  .eoe-app .panel{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:16px;margin:16px 0}
  .eoe-app label{display:block;margin:4px 0}
  .eoe-app .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  .eoe-app input[type="number"],.eoe-app input[type="text"],.eoe-app select{
    width:12ch;background:#0e1216;color:#cfe3f5;border:1px solid #2a3541;border-radius:6px;padding:6px
  }
  .eoe-app input[type="number"]#costPerBox{width:14ch}
  .eoe-app select{width:auto}
  .eoe-app button{appearance:none;border:1px solid #2c3845;background:#1b232c;color:var(--fg);padding:10px 14px;border-radius:8px;cursor:pointer}
  .eoe-app button[disabled]{opacity:.5;cursor:default}
  .eoe-app .actions{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 0}
  .eoe-app #status{margin-top:8px;color:var(--muted)}
  .eoe-app #counts b{color:#7ddc7a}

  /* Banner header/footer */
  .freBanner{display:flex;justify-content:center;margin:8px 0 16px}
  .freBanner img{max-width:420px;width:100%;height:auto;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.35)}

  /* Emphasis */
  .btn-primary{border-color:var(--hi-line);background:linear-gradient(180deg,#203245,#1a2530);color:#dff1ff;font-weight:600}
  .hi-label{border:1px solid var(--hi-line);background:var(--hi-bg);border-radius:8px;padding:6px 8px}
  .hi-inline{display:flex;align-items:center;gap:6px;border:1px solid var(--hi-line);background:var(--hi-bg);border-radius:8px;padding:6px 8px}

  /* Error panel */
  .error-panel{border-color:#ff7a7a!important}
  .error-panel h2{margin:0 0 8px;color:#ff7a7a;font-size:16px}
  .error-panel pre{white-space:pre-wrap;background:#0e1216;border:1px solid #2a3541;padding:8px;border-radius:6px;color:#ffd4d4}

  /* Tables */
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border:1px solid #2a3541;padding:8px 10px;text-align:right}
  th:first-child,td:first-child{text-align:left}
  thead th{background:#0e1216;position:sticky;top:0;z-index:1}
  tbody tr:nth-child(even){background:#12171d}

  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2a3541}
  .pill.ok{background:rgba(30,127,60,.20);color:#dff3e3;border-color:#1e7f3c}
  .pill.bad{background:rgba(155,44,44,.16);color:#ffdede;border-color:#9b2c2c}

  /* EV box highlight */
  .evbox table{margin:8px 0}
  .evbox table th,.evbox table td{border:1px solid #2a3541;padding:8px 10px}
  .evbox table thead th{background:#0e1216}
  .evbox table th:nth-child(3),
  .evbox table td:nth-child(3){
    background:var(--est-bg);
    border-color:var(--est-line);
    border-left-color:var(--est-line);
    color:#eaf6ff;
    font-weight:700;
  }
  .evbox table th:nth-child(2),
  .evbox table td:nth-child(2){border-right-color:var(--est-line)}

  /* Sift coloring */
  .sift-ok  { background:rgba(30,127,60,.18) !important; border-left:2px solid #1e7f3c; }
  .sift-bad { background:rgba(155,44,44,.16) !important; border-left:2px solid #9b2c2c; }

  /* Collapsible totals */
  details.eoe-collapse>summary{
    cursor:pointer;list-style:none;display:flex;justify-content:space-between;align-items:center;
    padding:8px 10px;border:1px solid #2a3541;border-radius:8px;background:#0e1216;color:#dfeeff;font-weight:600
  }
  details.eoe-collapse>summary::-webkit-details-marker{display:none}
  details.eoe-collapse>summary::after{content:'▼';opacity:.8;transform:rotate(-90deg);transition:transform .18s;margin-left:12px;font-size:12px}
  details.eoe-collapse[open]>summary::after{transform:rotate(0deg)}
  details.eoe-collapse .content{margin-top:10px}
</style>
</head>
<body>
<main class="eoe-app" aria-label="OTJ Play Booster EV app">
  <!-- Banner header -->
  <div class="freBanner">
    <a href="./index.html"><img src="freEV-banner.png" alt="FreEV — Spend your money on cards not calculators"></a>
  </div>

  <h1>Outlaws of Thunder Junction — Play Booster EV 1</h1>
  <p class="lede">
    Scryfall pricing on load. Playable cards renormalized to <b>14 cards/pack</b>.
    <br>OTP (Breaking News) modeled as a <b>dedicated 1/pack slot</b>; The List is <b>20% of packs</b> with <b>SPG = 1/64 packs</b>;
    non‑foil wildcard produces Rare/Mythic about <b>1/12</b> of the time (R:M ≈ 2:1). Foil slot share is divided across eligible prints.
  </p>

  <div class="panel">
    <strong>Refresh data</strong>
    <label><input type="checkbox" id="englishOnly" checked> English‑only (avoid dupes)</label>

    <div class="row">
      <label><input type="checkbox" id="includeOTJ" checked> Include <b>OTJ</b> main set (normal + foil)</label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="includeOTP" checked> Include <b>OTP</b> Breaking News (normal only)</label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="includeSPG" checked> Include <b>SPG</b> Special Guests (normal only)</label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="includeBIG" checked> Include <b>BIG</b> The Big Score (The List)</label>
    </div>

    <div id="status" aria-live="polite" style="margin-top:6px">Preparing…</div>
    <div id="counts" style="margin-top:4px"></div>

    <div class="actions" style="margin-top:10px">
      <button id="buildBtn" class="btn-primary">Refresh List</button>
    </div>

    <details style="margin-top:8px">
      <summary>Advanced: Scryfall queries</summary>
      <pre id="queries" style="white-space:pre-wrap;"></pre>
    </details>
  </div>

  <!-- Tokens (separate; UNCHECKED by default) -->
  <div class="panel">
    <strong>Tokens (TOTJ)</strong>
    <div class="row">
      <label><input type="checkbox" id="includeTOK"> Include <b>TOTJ</b> Tokens</label>
      <label>Token fallback (USD): <input type="text" id="tokenFallback" value="0.05" title="Used if token price missing"></label>
    </div>
  </div>

  <!-- Art Series (separate; UNCHECKED by default) -->
  <div class="panel">
    <strong>Art Series (AOTJ)</strong>
    <div class="row">
      <label><input type="checkbox" id="includeART"> Include <b>AOTJ</b> Art Series (normal + signed)</label>
      <label>Art fallback (USD): <input type="text" id="artFallback" value="0.00" title="Used if art price missing"></label>
    </div>
  </div>

  <!-- Purchase EV -->
  <div id="purchasePanel" class="panel" style="display:none">
    <strong>Purchase EV Calculator</strong>
    <div class="row" style="margin-top:6px">
      <label class="hi-label">Boxes to buy: <input type="number" id="boxesToBuy" value="1" min="0" step="1"></label>
      <span class="hi-inline" title="Only count prints with Card Value ≥ this amount">
        <input type="checkbox" id="useSiftForEV" checked>
        <b>Use Sift (≥)</b>
        <input type="text" id="siftMin" value="0.25">
      </span>
      <label class="hi-label" title="Your buy price per 36-pack box">
        Cost per box (USD): <input type="number" id="costPerBox" value="0" min="0" step="0.01">
      </label>
    </div>
    <div class="row" style="margin-top:6px">
      <label>TCGplayer seller
        <select id="sellerTier" title="Fee policy for EV/fees">
          <option value="mkt-l1">Marketplace Seller Level 1</option>
          <option value="mkt-l2">Marketplace Seller Level 2</option>
          <option value="mkt-l3">Marketplace Seller Level 3</option>
          <option value="mkt-l4" selected>Marketplace Seller Level 4</option>
          <option value="pro">Pro Seller</option>
        </select>
      </label>
      <label class="hi-label" title="Order-level transaction fees">
        Expected transactions:
        <input type="number" id="expectedTx" value="0" min="0" step="1">
        <span style="color:var(--muted);font-size:12px;margin-left:6px">
          transaction % always applies; $0.30 × N uses this field. Leave 0 if you count it as shipping.
        </span>
      </label>
    </div>
    <div class="row" style="margin-top:6px">
      <label><input type="radio" name="rangeMode" value="stat" checked> Statistical range (CLT)</label>
      <label><input type="radio" name="rangeMode" value="struct"> Structural range (slot band)</label>
      <label>Confidence:
        <select id="confLevel">
          <option value="68">68% (~1σ)</option>
          <option value="90">90% (~1.645σ)</option>
          <option value="95" selected>95% (~1.96σ)</option>
          <option value="99">99% (~2.576σ)</option>
        </select>
      </label>
      <button id="calcEV" disabled>Calculate EV</button>
    </div>
    <div id="purchaseSummary" class="note"></div>
    <div id="purchaseEVContainer" class="evbox" style="display:none"></div>
    <div id="rangeNotes" class="note"></div>
  </div>

  <!-- Sift table -->
  <div id="siftPanel" class="panel" style="display:none">
    <strong>Row List (linked)</strong>
    <div class="row">
      <span class="pill ok">≥ threshold</span>
      <span class="pill bad">&lt; threshold</span>
      <button id="applySift" disabled>Re‑Apply Sift</button>
    </div>
    <div id="siftSummary" class="note" aria-live="polite"></div>
    <div class="sift-tablewrap" id="siftTableWrap" style="display:none">
      <table id="siftTable">
        <thead>
          <tr>
            <th>Set</th><th>No.</th><th>R</th><th>Name</th><th>Treatment</th>
            <th>Pack Prob Min (%)</th>
            <th>Card Value (USD)</th><th>Fees/card (USD)</th>
            <th>Expected cards per 1000</th>
          </tr>
        </thead>
        <tbody id="siftBody"></tbody>
      </table>
    </div>
    <!-- Actions BELOW the table -->
    <div class="actions" id="dlRow" style="display:none">
      <button id="downloadCsv" disabled>Download CSV</button>
      <button id="downloadSiftCsv" disabled>Download Sift CSV</button>
    </div>
  </div>

  <!-- Errors -->
  <div id="errorBox" class="panel error-panel" style="display:none">
    <h2>Load failed</h2>
    <div id="errorMsg"></div>
    <pre id="errorDetails"></pre>
  </div>

  <!-- Totals (collapsible) -->
  <div id="totalsPanel" class="panel" style="display:none">
    <details id="totalsDetails" class="eoe-collapse" open>
      <summary>Totals (estimates)</summary>
      <div class="content">
        <table>
          <thead><tr><th>Metric</th><th>Across packs</th><th>Per 36‑pack box</th></tr></thead>
          <tbody id="totalsBody"></tbody>
        </table>
        <div id="totalsNotes" class="note"></div>
      </div>
    </details>
  </div>

  <!-- Banner footer -->
  <div class="freBanner">
    <a href="./index.html"><img src="freEV-banner.png" alt="FreEV — Spend your money on cards not calculators"></a>
  </div>
</main>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LWMRXKNY5X"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-LWMRXKNY5X');
</script>
<script>
/* ============================ Helpers ============================ */
const rarityLetter = r => ({common:'C',uncommon:'U',rare:'R',mythic:'M'}[r] || (r?r[0].toUpperCase():''));
const sleep = ms => new Promise(res=>setTimeout(res,ms));
const padCollector = s => { const m=String(s||'').match(/^(\d+)(.*)$/); return m?m[1].padStart(4,'0')+(m[2]||''):(s||''); };
const parseUSD = s => { const n=parseFloat(String(s).replace(/[^0-9.]/g,'')); return Number.isFinite(n)?n:null; };
const money = n => Number.isFinite(n)? n.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) : '';
const fmtUSD = n => money(n);
const fmtCount = n => !Number.isFinite(n)? '' : (Math.abs(n-Math.round(n))<1e-9? Math.round(n).toLocaleString() : (n>=100?n.toFixed(1):n>=10?n.toFixed(2):n.toFixed(3)));
const fmtInt = n => Number.isFinite(n)? Math.round(n).toLocaleString() : '';
const zFromConf = c => { c=Math.round(c); if(c>=99)return 2.576; if(c>=95)return 1.96; if(c>=90)return 1.645; if(c>=68)return 1.0; return 1.96; };
const priceUSD = (card,treat) => { const p=(treat==='foil'?card?.prices?.usd_foil:card?.prices?.usd); const f=parseFloat(p); return Number.isFinite(f)?f:null; };

/* ============================ TCGplayer Fees ============================ */
/* Marketplace (Level 1–4): 10.25% commission; Pro Seller: 9.25% commission + 2.5% Pro fee;
   Transaction fee: 2.5% + $0.30 per order; Commission+Pro capped at $50 per product. */
function getSellerPolicy(){
  const sel = document.getElementById('sellerTier');
  const v = sel && sel.value ? sel.value : 'mkt-l4';
  const txPct = 0.025, txFixed = 0.30;
  if(v === 'pro') return { key:v, label:'Pro Seller', commission:0.0925, pro:0.025, txPct, txFixed };
  return { key:v, label:'Marketplace Seller', commission:0.1025, pro:0, txPct, txFixed };
}
function perCardFeeUSD(price, policy){
  if(!Number.isFinite(price) || price<=0) return 0;
  const preCap = price * (policy.commission + policy.pro);
  return Math.min(preCap, 50.0);
}
function computeFeesSummary(packs, useSift, minUSD, policy){
  let gross=0, commPro=0;
  for(const row of __ROW_MODELS__){
    const p = probPoint(row.model); if(!Number.isFinite(p)) continue;
    const pS = row.nonGame? p : (p*__NORM_SCALE__);
    const usd = row.price;
    const ok = (!useSift) || (Number.isFinite(usd) && usd >= minUSD);
    if(!ok || !Number.isFinite(usd)) continue;
    const expected = pS * packs;
    gross  += usd * expected;
    commPro += perCardFeeUSD(usd, policy) * expected;
  }
  return { gross, commPro };
}

/* ======================= OTJ model constants (EVProject-aligned) ======================= */
const PACKS_PER_BOX = 36;
const OTJ_ODDS = {
  /* Base playable slots per pack (pre-normalization) */
  COMMON_SLOTS: 6,        // we'll subtract List (0.20) from this when distributing
  UNCOMMON_BASE: 3,
  RARE_SLOT: 1,
  WILDCARD: 1,            // extra non-foil wildcard of any rarity

  /* Rare slot split (R vs M) */
  RM_MYTHIC_RATE: 1/7.4,
  RM_RARE_RATE: 1 - (1/7.4),

  /* Non-foil wildcard R/M chance & internal split (≈1/12; 2:1 R:M) */
  WILDCARD_RM: 1/12,
  WILDCARD_R_SHARE: 2/3,
  WILDCARD_M_SHARE: 1/3,

  /* OTP Breaking News — dedicated 1/pack slot (U vs R/M, then R vs M) */
  OTP_U: 2/3,
  OTP_RM: 1/3,           // = 1 - OTP_U
  OTP_R_SHARE: 2/3,
  OTP_M_SHARE: 1/3,

  /* The List & Special Guests (OTJ): List in 20% of packs; SPG in 1/64 packs (of all packs) */
  LIST_RATE: 1/5,        // 0.20 packs
  SPG_PER_PACK: 1/64,    // ~0.015625 per pack (not "of the 20%")

  /* Lands (OTJ) */
  LAND_COMMON_DUALS: 1/2,
  LAND_WESTERN: 1/6,
  LAND_REGULAR: 1/3,
  LAND_FOIL_RATE: 0.20,  // land is foil ~20% of the time

  /* Foil modeling: one foil wildcard per pack, rarity shares across that slot */
  FOIL_SLOT: 1.0,
  FOIL_RARITY: { common:0.70, uncommon:0.22, rare:0.07, mythic:0.01 },

  /* Non-game (token/art) */
  NONGAME_TOKEN: 0.65,
  NONGAME_ART: 0.30,
  NONGAME_ART_SIGNED: 0.05
};

/* ========================= Derived odds helpers ========================= */
const PM = { point(p){ return { type:'point', p } } };
function probPoint(model){ return model?.type==='point'? model.p : null; }

/* ========================= Build logic ========================= */
let __ROW_MODELS__ = []; // { model, price, nonGame, fallback, url }
let __META_ROWS__  = []; // table view
let __NORM_SCALE__ = 1;
let __SIFT_CSV__   = '';
let __CSV__        = '';

/* ---------- NEW: Scryfall fetch with throttle & 429 backoff ---------- */
const REQUEST_GAP_MS = 250;      // space every request to ~4 req/s (well under 10 req/s)
const MAX_RETRIES = 6;           // on 429 or transient network errors
let __backoffUntil = 0;          // shared "Retry-After until" wall-clock time

async function waitForBackoff(){
  const now = Date.now();
  if (__backoffUntil > now) {
    const wait = __backoffUntil - now;
    document.getElementById('status').textContent = `Respecting Retry-After… waiting ${(wait/1000).toFixed(1)}s`;
    await sleep(wait);
  }
}

async function fetchWithBackoff(url, attempt=1){
  await waitForBackoff();
  let r;
  try {
    r = await fetch(url, { cache: 'no-store' });
  } catch (e) {
    if (attempt < MAX_RETRIES) {
      const jitter = 300 + Math.random()*400;
      await sleep(jitter);
      return fetchWithBackoff(url, attempt+1);
    }
    throw new Error(`Network error contacting Scryfall (${e && e.message ? e.message : e})`);
  }

  if (r.status === 429) {
    const ra = parseInt(r.headers.get('Retry-After')) || (2 ** Math.min(attempt, 6)); // seconds
    __backoffUntil = Date.now() + (ra * 1000);
    if (attempt < MAX_RETRIES) {
      document.getElementById('status').textContent = `Rate-limited by Scryfall (429). Retrying in ${ra}s…`;
      await sleep(ra * 1000);
      return fetchWithBackoff(url, attempt+1);
    }
    throw new Error(`Scryfall rate limit (429). Waited up to ${ra}s; giving up.`);
  }

  if (!r.ok) {
    throw new Error(`Scryfall fetch failed — HTTP ${r.status} ${r.statusText || ''}`.trim());
  }

  // Small friendly gap between *every* request (including pagination)
  await sleep(REQUEST_GAP_MS);
  return r.json();
}

async function fetchScryfallAll(url){
  let j = await fetchWithBackoff(url);
  let all = Array.isArray(j.data) ? j.data : [];
  let next = j.next_page;
  while (next) {
    document.getElementById('status').textContent = `Fetching (page ${all.length}-${all.length+175} approx)…`;
    j = await fetchWithBackoff(next);
    all = all.concat(Array.isArray(j.data) ? j.data : []);
    next = j.next_page;
  }
  return all;
}

async function build(){
  const statusEl = document.getElementById('status');
  statusEl.textContent='Building list…';
  document.getElementById('errorBox').style.display='none';
  document.getElementById('errorMsg').textContent='';
  document.getElementById('errorDetails').textContent='';
  document.getElementById('purchasePanel').style.display='none';
  document.getElementById('purchaseEVContainer').style.display='none';
  document.getElementById('siftPanel').style.display='none';
  document.getElementById('siftTableWrap').style.display='none';
  document.getElementById('dlRow').style.display='none';
  document.getElementById('siftSummary').textContent='';
  document.getElementById('counts').textContent='';

  const englishOnly=document.getElementById('englishOnly').checked;
  const incOTJ=document.getElementById('includeOTJ').checked;
  const incOTP=document.getElementById('includeOTP').checked;
  const incBIG=document.getElementById('includeBIG').checked;
  const incSPG=document.getElementById('includeSPG').checked;
  const incTOK=document.getElementById('includeTOK').checked;
  const incART=document.getElementById('includeART').checked;

  function buildQuery(setCode, englishOnly){
    let q='';
    if(setCode==='OTJ') q='e:otj is:booster';
    if(setCode==='OTP') q='e:otp';
    if(setCode==='BIG') q='e:big';
    if(setCode==='SPG') q='e:spg';
    if(setCode==='TOTJ') q='e:totj';
    if(setCode==='AOTJ') q='e:aotj';
    if(englishOnly) q+=' lang:en';
    return q.trim();
  }
  function linkOf(card){ return card?.scryfall_uri || ''; }

  const queries = [];
  if(incOTJ) queries.push({ code:'OTJ', q:buildQuery('OTJ',englishOnly) });
  if(incOTP) queries.