<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Outlaws of Thunder Junction — Play Booster EV (with TCGplayer Fees)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  html{background-color:#0b0d10}
  /* Scoped theme */
  .eoe-app{
    --bg:#0b0d10; --fg:#e8ecf1; --muted:#a7b0bb; --acc:#6ac1ff;
    --card:#151a20; --line:#222a33; --ok:#1e7f3c; --warn:#9b2c2c;
    --hi-bg:rgba(106,193,255,.14); --hi-line:#6ac1ff;
    max-width:1120px; margin:32px auto; padding:0 16px; color:var(--fg); background:var(--bg);
    font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }
  .eoe-app a{ color:var(--acc); text-decoration:underline }
  h1{font-size:22px;margin:0 0 12px}
  p.lede{color:var(--muted);margin:0 0 12px}
  .panel{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:16px;margin:16px 0}
  label{display:block;margin:6px 0}
  .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  input[type="number"],input[type="text"],select{
    background:#0e1216;color:#cfe3f5;border:1px solid #2a3541;border-radius:6px;padding:6px
  }
  button{appearance:none;border:1px solid #2c3845;background:#1b232c;color:var(--fg);
    padding:10px 14px;border-radius:8px;cursor:pointer}
  button[disabled]{opacity:.55;cursor:default}
  .btn-primary{
    border-color:var(--hi-line);background:linear-gradient(180deg,#203245,#1a2530);
    color:#dff1ff;font-weight:600;animation:pulse 2.2s infinite;
  }
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(106,193,255,.45)}70%{box-shadow:0 0 0 10px rgba(106,193,255,0)}100%{box-shadow:0 0 0 0 rgba(106,193,255,0)}}
  .hi-inline{display:flex;align-items:center;gap:6px;border:1px solid var(--hi-line);background:var(--hi-bg);border-radius:8px;padding:6px 8px}
  .hi-label{border:1px solid var(--hi-line);background:var(--hi-bg);border-radius:8px;padding:6px 8px}

  .freBanner{display:flex;justify-content:center;margin:8px 0 16px}
  .freBanner img{max-width:420px;width:100%;height:auto;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.35)}

  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border:1px solid #2a3541;padding:6px 8px;text-align:right}
  th:first-child,td:first-child{text-align:left}
  thead th{background:#0e1216;position:sticky;top:0;z-index:1}
  tbody tr:nth-child(even){background:#12171d}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2a3541}
  .pill.ok{background:rgba(30,127,60,.20);color:#d9ffe3;border-color:#1e7f3c}
  .pill.bad{background:rgba(155,44,44,.16);color:#ffdede;border-color:#9b2c2c}
  .sift-ok{background:rgba(30,127,60,.12)!important}
  .sift-bad{background:rgba(155,44,44,.10)!important}

  .note{color:#a7b0bb;font-size:12px;margin-top:6px}
  .error-panel{border-color:#ff7a7a!important}
  .error-panel h2{margin:0 0 8px;color:#ff7a7a;font-size:16px}
  .error-panel pre{white-space:pre-wrap;background:#0e1216;border:1px solid #2a3541;padding:8px;border-radius:6px;color:#ffd4d4}

  /* Compact table for your simplified columns */
  .compact th,.compact td{white-space:nowrap}
  .feeHint{cursor:help;border-bottom:1px dotted #6ac1ff}
</style>
</head>
<body>
<main class="eoe-app" aria-label="OTJ Play Booster EV">
  <!-- Banner -->
  <div class="freBanner">
    <a href="./index.html"><img src="freEV-banner.png" alt="FreEV — Spend your money on cards not calculators"></a>
  </div>

  <h1>Outlaws of Thunder Junction — Play Booster EV TCG</h1>
  <p class="lede">
    Builds on load using Scryfall. Playing‑card odds are normalized to exactly <b>14 cards per pack</b> (non‑game items modeled separately). This view adds a <b>TCGplayer fee calculator</b> with a seller‑type dropdown.
  </p>

  <!-- Refresh & Options -->
  <div class="panel">
    <strong>Refresh data</strong>
    <label><input type="checkbox" id="englishOnly" checked> English‑only (avoid dupes)</label>

    <label><input type="checkbox" id="includeOTJ" checked> Include <b>OTJ</b> (main set, <code>is:booster</code>)</label>
    <label><input type="checkbox" id="includeOTP" checked> Include <b>OTP</b> (Breaking News — approx. 1 per pack)</label>
    <label><input type="checkbox" id="includeBIG" checked> Include <b>BIG</b> (The Big Score — “List” slot)</label>
    <label><input type="checkbox" id="includeSPG" checked> Include <b>SPG</b> (Special Guests — nonfoil only)</label>

    <label><input type="checkbox" id="includeTOK"> Include <b>TOTJ</b> tokens</label>
    <label>Token fallback (USD): <input type="text" id="tokenFallback" value="0.05"></label>
    <label><input type="checkbox" id="includeART"> Include <b>AOTJ</b> Art Series (normal + signed)</label>
    <label>Art fallback (USD): <input type="text" id="artFallback" value="0.00"></label>

    <div class="actions">
      <button id="buildBtn" class="btn-primary">Refresh List</button>
    </div>
    <div id="status" class="note" aria-live="polite">Preparing…</div>
    <div id="counts" class="note"></div>
  </div>

  <!-- Seller Fee Settings -->
  <div class="panel">
    <strong>TCGplayer Seller Fees</strong>
    <div class="row" style="margin-top:6px">
      <label>Seller type:
        <select id="sellerType">
          <option value="l4">Marketplace (Level 4)</option>
          <option value="pro">Marketplace (Pro Seller)</option>
        </select>
      </label>
      <span class="hi-inline">
        <input type="checkbox" id="useSift" checked>
        <b>Use Sift (≥)</b>
        <input type="text" id="siftMin" value="0.25" style="width:8ch">
      </span>
      <button id="applySift" disabled>Apply</button>
    </div>
    <div class="note">
      Fees follow TCGplayer’s current tables: **Level 1–4: 10.25% commission + 2.5% processing + $0.30**; **Pro: 9.25% commission + 2.5% Pro fee + 2.5% processing + $0.30**.
      Each commission/Pro component is capped at **$50 per product**. Per‑row estimates treat order subtotal/total ≈ card price and apply banker’s rounding to cents. :contentReference[oaicite:2]{index=2}
    </div>
  </div>

  <!-- Row list (simplified columns) -->
  <div id="siftPanel" class="panel" style="display:none">
    <strong>Row List (linked)</strong>
    <div class="row">
      <span class="pill ok">≥ threshold</span>
      <span class="pill bad">&lt; threshold</span>
    </div>
    <div id="siftSummary" class="note"></div>
    <div class="sift-tablewrap" id="siftTableWrap" style="display:none; border:1px solid #2a3541;border-radius:8px;max-height:560px;overflow:auto">
      <table id="siftTable" class="compact">
        <thead>
          <tr>
            <th>Name</th>
            <th>Treatment</th>
            <th>Drop %</th>
            <th>Value</th>
            <th>Seller Fee</th>
            <th>Expected / 10,000</th>
          </tr>
        </thead>
        <tbody id="siftBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Error box -->
  <div id="errorBox" class="panel error-panel" style="display:none">
    <h2>Load failed</h2>
    <div id="errorMsg"></div>
    <pre id="errorDetails"></pre>
  </div>

  <!-- Footer banner -->
  <div class="freBanner">
    <a href="./index.html"><img src="freEV-banner.png" alt="FreEV — Spend your money on cards not calculators"></a>
  </div>
</main>

<!-- Google tag (gtag.js) BEFORE first custom script -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LWMRXKNY5X"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-LWMRXKNY5X');
</script>

<script>
/* ====================== Helpers & rounding ====================== */
const rarityLetter = r => ({common:'C',uncommon:'U',rare:'R',mythic:'M'}[r] || (r?r[0].toUpperCase():'')); 
const sleep = ms => new Promise(res=>setTimeout(res,ms));
const parseUSD = s => { const n=parseFloat(String(s).replace(/[^0-9.]/g,'')); return Number.isFinite(n)?n:null; };
const money = n => Number.isFinite(n)? n.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) : '';
function bankersRound(n, decimals=2){
  const m = Math.pow(10, decimals);
  const x = n*m;
  const f = Math.floor(x), diff = x - f;
  if (Math.abs(diff - 0.5) < 1e-8) return ((f % 2 === 0) ? f : f+1)/m;
  return Math.round(x)/m;
}

/* ====================== Fee profiles (TCGplayer) ======================
   Source: TCGplayer Help Center (Marketplace Fees & Examples). 
   Level 1–4: 10.25% commission; Pro: 9.25% commission + 2.5% Pro fee; both add 2.5% processing + $0.30/txn. 
   Each of commission & Pro is capped at $50 per product. :contentReference[oaicite:3]{index=3}
*/
const FeeProfiles = {
  l4: { commission:0.1025, pro:0.0,   processing:0.025, txnFixed:0.30 },
  pro:{ commission:0.0925, pro:0.025, processing:0.025, txnFixed:0.30 }
};
function calcFees(price, sellerType){
  const fp = FeeProfiles[sellerType] || FeeProfiles.l4;
  const subtotal = price;   // assumption for per-print estimate
  const orderTot = price;   // assume items only; shipping/tax vary by order
  let commission = Math.min(fp.commission * subtotal, 50);
  let profee     = Math.min(fp.pro        * subtotal, 50);
  let procPerc   = fp.processing * orderTot;
  const txn      = fp.txnFixed;
  commission = bankersRound(commission);
  profee     = bankersRound(profee);
  procPerc   = bankersRound(procPerc);
  const processing = bankersRound(procPerc + txn);
  const total = bankersRound(commission + profee + processing);
  return {commission, profee, procPerc, txn, processing, total};
}

/* ====================== Pack model (OTJ) ======================
   Heuristic Play Booster model (normalized to 14 playing cards/pack):
   - Common/Uncommon slots include a portion of the wildcard.
   - Rare slot: 7/8 Rare, 1/8 Mythic, plus the R/M share from the wildcard.
   - Foil slot rarity split: ~58%C / ~32%U / ~6.4%R / ~1.1%M.
   - OTP (Breaking News): roughly 1 per pack (shared across OTP prints).
   - BIG (The Big Score): treat as “List” ~20% of packs (heuristic).
   - SPG (Special Guests): treat as nonfoil “List” micro slot (~1/64 packs).
   We normalize *playing cards* so the mass sums to 14. Non‑game items aren’t normalized.
   Reference on “20% special card” (heuristic): community summaries around OTJ release. :contentReference[oaicite:4]{index=4}
*/
const PACKS_PER_BOX = 36; // OTJ Play Booster displays are 36 packs
const OTJ_ODDS = {
  COMMON_SLOTS: 7 + 0.125,
  UNCOMMON_BASE: 3 + 0.625,
  WILDCARD_RM: 1/12,
  RM_MYTHIC_RATE: 1/8,
  RM_RARE_RATE: 7/8,
  FOIL_C: 0.58, FOIL_U: 0.32, FOIL_R: 0.064, FOIL_M: 0.011,
  OTP_PER_PACK: 1.0,        // Breaking News ~1 per pack (shared across prints)
  BIG_PER_PACK: 0.20,       // “special card” heuristic ~20%
  SPG_PER_PACK_NF: 1/64,    // nonfoil only, small List-like rate
  NONGAME_TOKEN: 0.65, NONGAME_ART: 0.30, NONGAME_ART_SIGNED: 0.05
};

/* ====================== State ====================== */
let __ROWS__=[]; // {name,treat,pModel,price,url,isNonGame}
let __NORM_SCALE__=1;

/* ====================== Queries ====================== */
function qMain(englishOnly){
  let q='e:otj is:booster -finish:glossy -finish:etched -finish:textured';
  if(englishOnly) q+=' lang:en';
  return q;
}
function qOTP(englishOnly){
  let q='e:otp is:booster -finish:textured';
  if(englishOnly) q+=' lang:en';
  return q;
}
function qBIG(englishOnly){
  let q='e:big is:booster -finish:foil';
  if(englishOnly) q+=' lang:en';
  return q;
}
function qSPG(englishOnly){
  let q='e:spg is:booster -finish:foil';
  if(englishOnly) q+=' lang:en';
  return q;
}
function qTOK(englishOnly){
  let q='e:totj (layout:token or layout:double_faced_token or layout:emblem)';
  if(englishOnly) q+=' lang:en';
  return q;
}
function qART(englishOnly){
  let q='e:aotj';
  if(englishOnly) q+=' lang:en';
  return q;
}
async function fetchAll(q, tag, statusEl){
  const base='https://api.scryfall.com/cards/search?unique=prints&order=set&dir=asc&q=';
  let url=base+encodeURIComponent(q), out=[], p=1;
  while(url){
    statusEl.textContent=`Fetching ${tag}… (page ${p})`;
    const r=await fetch(url);
    if(!r.ok){ const t=await r.text().catch(()=> ''); throw {set:tag,query:q,status:r.status,details:t}; }
    const j=await r.json();
    out=out.concat(j.data||[]);
    url=j.has_more? j.next_page : null;
    p++; if(url) await sleep(120);
  }
  return out.filter(c=> (c.games||[]).includes('paper'));
}

/* ====================== Probability helpers ====================== */
const PM = { point:p=>({type:'point',p}) };
const probPoint = m => m?.type==='point'? m.p : null;

/* ====================== Build ====================== */
async function build(){
  // reset
  document.getElementById('errorBox').style.display='none';
  document.getElementById('status').textContent='Building list…';
  document.getElementById('siftPanel').style.display='none';
  document.getElementById('siftTableWrap').style.display='none';
  document.getElementById('siftBody').innerHTML='';
  __ROWS__=[]; __NORM_SCALE__=1;

  const englishOnly = document.getElementById('englishOnly').checked;
  const incOTJ = document.getElementById('includeOTJ').checked;
  const incOTP = document.getElementById('includeOTP').checked;
  const incBIG = document.getElementById('includeBIG').checked;
  const incSPG = document.getElementById('includeSPG').checked;
  const incTOK = document.getElementById('includeTOK').checked;
  const incART = document.getElementById('includeART').checked;
  const tokenFallback = parseUSD(document.getElementById('tokenFallback').value);
  const artFallback   = parseUSD(document.getElementById('artFallback').value);
  const status = document.getElementById('status');
  const counts = document.getElementById('counts');

  try{
    const bundles = [];
    if(incOTJ) bundles.push(['OTJ', await fetchAll(qMain(englishOnly),'OTJ',status)]);
    if(incOTP) bundles.push(['OTP', await fetchAll(qOTP(englishOnly),'OTP',status)]);
    if(incBIG) bundles.push(['BIG', await fetchAll(qBIG(englishOnly),'BIG',status)]);
    if(incSPG) bundles.push(['SPG', await fetchAll(qSPG(englishOnly),'SPG',status)]);
    if(incTOK) bundles.push(['TOK', await fetchAll(qTOK(englishOnly),'TOTJ tokens',status)]);
    if(incART) bundles.push(['ART', await fetchAll(qART(englishOnly),'AOTJ art',status)]);

    // Split OTJ pools
    const otjAll = (bundles.find(b=>b[0]==='OTJ')||[null,[]])[1];
    const C = otjAll.filter(c=>c.rarity==='common');
    const U = otjAll.filter(c=>c.rarity==='uncommon');
    const R = otjAll.filter(c=>c.rarity==='rare');
    const M = otjAll.filter(c=>c.rarity==='mythic');

    const P = OTJ_ODDS;

    // Nonfoil main per print
    const cuTotal = (C.length + U.length) || 1;
    const wcCU = 1 - P.WILDCARD_RM;
    const wcCshare = wcCU * (C.length/cuTotal);
    const wcUshare = wcCU * (U.length/cuTotal);
    const pCommonNF   = C.length? (P.COMMON_SLOTS/C.length)  + (wcCshare/C.length) : 0;
    const pUncommonNF = U.length? (P.UNCOMMON_BASE/U.length) + (wcUshare/U.length) : 0;
    const pRareNF     = R.length? ((P.RM_RARE_RATE)/R.length)     + ((P.WILDCARD_RM*P.RM_RARE_RATE)/R.length) : 0;
    const pMythicNF   = M.length? ((P.RM_MYTHIC_RATE)/M.length)   + ((P.WILDCARD_RM*P.RM_MYTHIC_RATE)/M.length) : 0;

    // Foil slot split by rarity (only foilable prints)
    const foilC = C.filter(c=>(c.finishes||[]).includes('foil'));
    const foilU = U.filter(c=>(c.finishes||[]).includes('foil'));
    const foilR = R.filter(c=>(c.finishes||[]).includes('foil'));
    const foilM = M.filter(c=>(c.finishes||[]).includes('foil'));
    const pFoilC = foilC.length? P.FOIL_C/foilC.length : 0;
    const pFoilU = foilU.length? P.FOIL_U/foilU.length : 0;
    const pFoilR = foilR.length? P.FOIL_R/foilR.length : 0;
    const pFoilM = foilM.length? P.FOIL_M/foilM.length : 0;

    // Push OTJ rows
    function pushRow(card, treat, p, isNonGame=false, overrideUSD=null){
      const usd = (overrideUSD!==null)? overrideUSD :
                  (treat==='foil'? parseUSD(card?.prices?.usd_foil): parseUSD(card?.prices?.usd));
      __ROWS__.push({
        name: card.name, treat, pModel: PM.point(p), price: usd, url: card.scryfall_uri||'',
        isNonGame
      });
    }
    for(const c of otjAll){
      const f = Array.isArray(c.finishes)?c.finishes:[];
      if(f.includes('nonfoil')){
        if(c.rarity==='common')   pushRow(c,'normal',pCommonNF);
        if(c.rarity==='uncommon') pushRow(c,'normal',pUncommonNF);
        if(c.rarity==='rare')     pushRow(c,'normal',pRareNF);
        if(c.rarity==='mythic')   pushRow(c,'normal',pMythicNF);
      }
      if(f.includes('foil')){
        if(c.rarity==='common')   pushRow(c,'foil',pFoilC);
        if(c.rarity==='uncommon') pushRow(c,'foil',pFoilU);
        if(c.rarity==='rare')     pushRow(c,'foil',pFoilR);
        if(c.rarity==='mythic')   pushRow(c,'foil',pFoilM);
      }
    }

    // OTP: 1 per pack distributed across prints (include foil & nonfoil)
    const otp = (bundles.find(b=>b[0]==='OTP')||[null,[]])[1];
    if(incOTP && otp.length){
      const perPrint = P.OTP_PER_PACK / otp.length;
      for(const c of otp){
        const fins = c.finishes||[];
        if(fins.includes('nonfoil')) pushRow(c,'normal',perPrint,false,null);
        if(fins.includes('foil'))    pushRow(c,'foil',perPrint,false,null);
      }
    }

    // BIG: “The Big Score” — List-like ~20% of packs, nonfoil only
    const big = (bundles.find(b=>b[0]==='BIG')||[null,[]])[1];
    if(incBIG && big.length){
      const perPrint = P.BIG_PER_PACK / big.length;
      for(const c of big){
        const fins=c.finishes||[];
        if(fins.includes('nonfoil')) pushRow(c,'normal',perPrint,false,null);
      }
    }

    // SPG: Special Guests — nonfoil only, small List-like rate
    const spg = (bundles.find(b=>b[0]==='SPG')||[null,[]])[1];
    if(incSPG && spg.length){
      const perPrint = P.SPG_PER_PACK_NF / spg.length;
      for(const c of spg){
        const fins=c.finishes||[];
        if(fins.includes('nonfoil')) pushRow(c,'normal',perPrint,false,null);
      }
    }

    // Non‑game: tokens
    const tok = (bundles.find(b=>b[0]==='TOK')||[null,[]])[1];
    if(incTOK && tok.length){
      const per = OTJ_ODDS.NONGAME_TOKEN / tok.length;
      for(const c of tok){
        const usd = parseUSD(c?.prices?.usd);
        const val = Number.isFinite(usd)? usd : (Number.isFinite(tokenFallback)? tokenFallback : null);
        pushRow(c,'token',per,true,val);
      }
    }
    // Non‑game: art (normal + signed split)
    const art = (bundles.find(b=>b[0]==='ART')||[null,[]])[1];
    if(incART && art.length){
      const n=art.length||1;
      const pNormal = OTJ_ODDS.NONGAME_ART / n;
      const pSigned = OTJ_ODDS.NONGAME_ART_SIGNED / n;
      for(const c of art){
        const usd = parseUSD(c?.prices?.usd);
        const val = Number.isFinite(usd)? usd : (Number.isFinite(artFallback)? artFallback : null);
        pushRow(c,'art',pNormal,true,val);
        pushRow(c,'signed',pSigned,true,val);
      }
    }

    // Normalize playing-card mass to 14 per pack
    const mass = __ROWS__.reduce((s,r)=> s + (r.isNonGame?0:(probPoint(r.pModel)||0)), 0);
    __NORM_SCALE__ = mass>0 ? (14/mass) : 1;

    // Sort by name, then treatment
    __ROWS__.sort((a,b)=> (a.name||'').localeCompare(b.name||'') || (a.treat||'').localeCompare(b.treat||''));

    // Counts & UI
    const tot=__ROWS__.length, nonGame=__ROWS__.filter(r=>r.isNonGame).length;
    counts.innerHTML = `Built <b>${tot.toLocaleString()}</b> rows — Playing cards: <b>${(tot-nonGame).toLocaleString()}</b>, Non‑game: <b>${nonGame.toLocaleString()}</b>.`;
    document.getElementById('siftPanel').style.display='';
    document.getElementById('applySift').disabled=false;
    document.getElementById('status').textContent=`Done. (Normalization: ${__NORM_SCALE__.toFixed(5)} to 14 cards/pack)`;

    // Initial render with current sellerType & sift
    applySift();
  }catch(err){
    console.error(err);
    document.getElementById('status').textContent='Error while 