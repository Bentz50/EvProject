<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Outlaws of Thunder Junction — Play Booster EV (with TCGplayer Fees)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  html{background-color:#0b0d10}
  /* Scoped theme */
  .eoe-app{
    --bg:#0b0d10; --fg:#e8ecf1; --muted:#a7b0bb; --acc:#6ac1ff;
    --card:#151a20; --line:#222a33; --ok:#1e7f3c; --warn:#9b2c2c;
    --hi-bg:rgba(106,193,255,.14); --hi-line:#6ac1ff;
    --est-bg:rgba(106,193,255,.18); --est-line:#6ac1ff;
    max-width:1120px; margin:32px auto; padding:0 16px; color:var(--fg); background:var(--bg);
    font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }
  .eoe-app a{ color:var(--acc); text-decoration:underline }
  h1{font-size:22px;margin:0 0 12px}
  p.lede{color:#a7b0bb;margin:0 0 12px}
  .panel{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:16px;margin:16px 0}
  label{display:block;margin:6px 0}
  .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  input[type="number"],input[type="text"],select{
    background:#0e1216;color:#cfe3f5;border:1px solid #2a3541;border-radius:6px;padding:6px
  }
  button{appearance:none;border:1px solid #2c3845;background:#1b232c;color:var(--fg);
    padding:10px 14px;border-radius:8px;cursor:pointer}
  button[disabled]{opacity:.55;cursor:default}
  .btn-primary{
    border-color:var(--hi-line);background:linear-gradient(180deg,#203245,#1a2530);
    color:#dff1ff;font-weight:600;animation:pulse 2.2s infinite;
  }
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(106,193,255,.45)}70%{box-shadow:0 0 0 10px rgba(106,193,255,0)}100%{box-shadow:0 0 0 0 rgba(106,193,255,0)}}
  .hi-inline{display:flex;align-items:center;gap:6px;border:1px solid var(--hi-line);background:var(--hi-bg);border-radius:8px;padding:6px 8px}
  .hi-label{border:1px solid var(--hi-line);background:var(--hi-bg);border-radius:8px;padding:6px 8px}

  .freBanner{display:flex;justify-content:center;margin:8px 0 16px}
  .freBanner img{max-width:420px;width:100%;height:auto;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.35)}

  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border:1px solid #2a3541;padding:6px 8px;text-align:right}
  th:first-child,td:first-child{text-align:left}
  thead th{background:#0e1216;position:sticky;top:0;z-index:1}
  tbody tr:nth-child(even){background:#12171d}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2a3541}
  .pill.ok{background:rgba(30,127,60,.20);color:#d9ffe3;border-color:#1e7f3c}
  .pill.bad{background:rgba(155,44,44,.16);color:#ffdede;border-color:#9b2c2c}
  .sift-ok{background:rgba(30,127,60,.12)!important}
  .sift-bad{background:rgba(155,44,44,.10)!important}

  .note{color:#a7b0bb;font-size:12px;margin-top:6px}
  .error-panel{border-color:#ff7a7a!important}
  .error-panel h2{margin:0 0 8px;color:#ff7a7a;font-size:16px}
  .error-panel pre{white-space:pre-wrap;background:#0e1216;border:1px solid #2a3541;padding:8px;border-radius:6px;color:#ffd4d4}

  /* Compact row-table */
  .compact th,.compact td{white-space:nowrap}
  .feeHint{cursor:help;border-bottom:1px dotted #6ac1ff}

  /* EV table highlight for Est. column (two-column table uses 2nd col) */
  .evbox th:nth-child(2), .evbox td:nth-child(2){
    background:var(--est-bg); border-color:var(--est-line); border-left-color:var(--est-line);
    color:#eaf6ff; font-weight:700;
  }
</style>
</head>
<body>
<main class="eoe-app" aria-label="OTJ Play Booster EV">
  <!-- Banner -->
  <div class="freBanner">
    <a href="./index.html"><img src="freEV-banner.png" alt="FreEV — Spend your money on cards not calculators"></a>
  </div>

  <h1>Outlaws of Thunder Junction — Play Booster EV</h1>
  <p class="lede">
    Scryfall pricing on load. Playing cards normalized to exactly <b>14 cards per pack</b>.
    SPG/BIG/OTP queries auto‑fallback if <code>is:booster</code> isn’t indexed, so one failing block won’t kill the whole build.
    TCGplayer fees: rows show <b>percent fees only</b>; the flat <b>$0.30/transaction</b> is applied only in totals via <em>Expected transactions</em>.
  </p>

  <!-- Refresh & Options -->
  <div class="panel">
    <strong>Refresh data</strong>
    <label><input type="checkbox" id="englishOnly" checked> English‑only (avoid dupes)</label>

    <label><input type="checkbox" id="includeOTJ" checked> Include <b>OTJ</b> (main set)</label>
    <label><input type="checkbox" id="includeOTP" checked> Include <b>OTP</b> (Breaking News)</label>
    <label><input type="checkbox" id="includeBIG" checked> Include <b>BIG</b> (The Big Score)</label>
    <label><input type="checkbox" id="includeSPG" checked> Include <b>SPG</b> (Special Guests — nonfoil)</label>

    <label><input type="checkbox" id="includeTOK"> Include <b>TOTJ</b> tokens</label>
    <label>Token fallback (USD): <input type="text" id="tokenFallback" value="0.05"></label>
    <label><input type="checkbox" id="includeART"> Include <b>AOTJ</b> Art Series (normal + signed)</label>
    <label>Art fallback (USD): <input type="text" id="artFallback" value="0.00"></label>

    <div class="actions">
      <button id="buildBtn" class="btn-primary">Refresh List</button>
    </div>
    <div id="status" class="note" aria-live="polite">Booting…</div>
    <div id="counts" class="note"></div>
  </div>

  <!-- Seller Fee Settings -->
  <div class="panel">
    <strong>TCGplayer Seller Fees</strong>
    <div class="row" style="margin-top:6px">
      <label>Seller type:
        <select id="sellerType">
          <option value="l4">Marketplace (Level 4)</option>
          <option value="pro">Marketplace (Pro Seller)</option>
        </select>
      </label>
      <span class="hi-inline">
        <input type="checkbox" id="useSift" checked>
        <b>Use Sift (≥)</b>
        <input type="text" id="siftMin" value="0.25" style="width:8ch">
      </span>
      <button id="applySift" disabled>Re‑Apply Sift</button>
    </div>
    <div class="note">
      <b>Per‑item</b> “Seller Fee” shown below covers only the <b>percentage components</b> (commission, Pro if applicable, processing 2.5%).
      The flat <b>$0.30/transaction</b> is <u>not</u> applied per row and is added only in EV totals via your <em>Expected transactions</em>.
    </div>
  </div>

  <!-- Purchase EV (gross vs net after fees) -->
  <div id="evPanel" class="panel" style="display:none">
    <strong>Purchase EV</strong>
    <div class="row" style="margin-top:6px">
      <label class="hi-label">Boxes to buy: <input type="number" id="boxesToBuy" value="1" min="0" step="1" style="width:10ch"></label>
      <label class="hi-label">Packs per box: <input type="number" id="packsPerBox" value="36" min="1" step="1" style="width:8ch"></label>
      <span class="hi-inline"><input type="checkbox" id="applyFeesToEV" checked> <b>Apply TCGplayer Fees to EV</b></span>
    </div>
    <div class="row" style="margin-top:6px">
      <label class="hi-label">Expected transactions: <input type="number" id="txnCount" value="0" min="0" step="1" style="width:10ch"></label>
    </div>
    <div class="note">
      <b>Set a value here only if you don’t already include the flat $0.30/transaction in your shipping fees.</b>
    </div>
    <div class="row" style="margin-top:6px">
      <button id="calcEV">Calculate EV</button>
    </div>
    <div id="evOut" class="evbox" style="display:none">
      <table>
        <thead><tr><th>Metric</th><th>Est.</th></tr></thead>
        <tbody id="evBody"></tbody>
      </table>
    </div>
    <div id="evNotes" class="note"></div>
  </div>

  <!-- Row list (simplified columns) -->
  <div id="siftPanel" class="panel" style="display:none">
    <strong>Row List (linked)</strong>
    <div class="row">
      <span class="pill ok">≥ threshold</span>
      <span class="pill bad">&lt; threshold</span>
    </div>
    <div id="siftSummary" class="note"></div>
    <div class="sift-tablewrap" id="siftTableWrap" style="display:none; border:1px solid #2a3541;border-radius:8px;max-height:560px;overflow:auto">
      <table id="siftTable" class="compact">
        <thead>
          <tr>
            <th>Name</th>
            <th>Treatment</th>
            <th>Drop %</th>
            <th>Value</th>
            <th>Seller Fee</th>
            <th>Expected / 10,000</th>
          </tr>
        </thead>
        <tbody id="siftBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Error box -->
  <div id="errorBox" class="panel error-panel" style="display:none">
    <h2>Load failed</h2>
    <div id="errorMsg"></div>
    <pre id="errorDetails"></pre>
  </div>

  <!-- Footer banner -->
  <div class="freBanner">
    <a href="./index.html"><img src="freEV-banner.png" alt="FreEV — Spend your money on cards not calculators"></a>
  </div>
</main>

<!-- Google tag (gtag.js) BEFORE first custom script -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LWMRXKNY5X"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-LWMRXKNY5X');
</script>

<script>
/* ====================== Helpers & rounding ====================== */
const sleep = ms => new Promise(res=>setTimeout(res,ms));
const parseUSD = s => { const n=parseFloat(String(s).replace(/[^0-9.]/g,'')); return Number.isFinite(n)?n:null; };
const money = n => Number.isFinite(n)? n.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) : '';
function bankersRound(n, decimals=2){
  const m = Math.pow(10, decimals);
  const x = n*m;
  const f = Math.floor(x), diff = x - f;
  if (Math.abs(diff - 0.5) < 1e-8) return ((f % 2 === 0) ? f : f+1)/m;
  return Math.round(x)/m;
}

/* ====================== Fee profiles (TCGplayer) ======================
   Percent components only at row-level (commission + pro (if any) + processing 2.5%).
   Flat $0.30/txn is added only in totals using Expected transactions.
*/
const FeeProfiles = {
  l4: { commission:0.1025, pro:0.0,   processing:0.025 },
  pro:{ commission:0.0925, pro:0.025, processing:0.025 }
};
function calcPercentFees(price, sellerType){
  const fp = FeeProfiles[sellerType] || FeeProfiles.l4;
  const subtotal = price, orderTot = price;
  let commission = Math.min(fp.commission * subtotal, 50);
  let profee     = Math.min(fp.pro        * subtotal, 50);
  let procPerc   = fp.processing * orderTot;
  commission = bankersRound(commission);
  profee     = bankersRound(profee);
  procPerc   = bankersRound(procPerc);
  const percentTotal = bankersRound(commission + profee + procPerc);
  return {commission, profee, procPerc, percentTotal};
}
function netAfterPercentFees(price, sellerType){
  const f = calcPercentFees(price, sellerType);
  return bankersRound(price - f.percentTotal);
}

/* ====================== Pack model (OTJ) & state ====================== */
const PACKS_PER_BOX_DEFAULT = 36;
const OTJ_ODDS = {
  COMMON_SLOTS: 7 + 0.125,
  UNCOMMON_BASE: 3 + 0.625,
  WILDCARD_RM: 1/12,
  RM_MYTHIC_RATE: 1/8,
  RM_RARE_RATE: 7/8,
  FOIL_C: 0.58, FOIL_U: 0.32, FOIL_R: 0.064, FOIL_M: 0.011,
  OTP_PER_PACK: 1.0,
  BIG_PER_PACK: 0.20,
  SPG_PER_PACK_NF: 1/64,
  NONGAME_TOKEN: 0.65, NONGAME_ART: 0.30, NONGAME_ART_SIGNED: 0.05
};
let __ROWS__=[]; // {name,treat,p,price,url,isNonGame}
let __NORM_SCALE__=1;

/* ====================== Scryfall queries with fallbacks ====================== */
function qOTJ_main(english){ let q='e:otj is:booster -finish:glossy -finish:etched -finish:textured'; if(english) q+=' lang:en'; return q; }
function qOTP_try(english){  // prefer booster, fallback no is:booster
  const q1='e:otp is:booster -finish:textured' + (english?' lang:en':'');
  const q2='e:otp -finish:textured' + (english?' lang:en':'');
  return [q1,q2];
}
function qBIG_try(english){
  const q1='e:big is:booster -finish:foil' + (english?' lang:en':'');
  const q2='e:big -finish:foil' + (english?' lang:en':'');
  return [q1,q2];
}
function qSPG_try(english){
  const q1='e:spg is:booster -finish:foil' + (english?' lang:en':'');
  const q2='e:spg -finish:foil' + (english?' lang:en':''); // many SPG prints aren’t tagged booster
  return [q1,q2];
}
function qTOK(english){ let q='e:totj (layout:token or layout:double_faced_token or layout:emblem)'; if(english) q+=' lang:en'; return q; }
function qART(english){ let q='e:aotj'; if(english) q+=' lang:en'; return q; }

async function fetchAllPages(q, tag, statusEl){
  const base='https://api.scryfall.com/cards/search?unique=prints&order=set&dir=asc&q=';
  let url=base+encodeURIComponent(q), out=[], page=1;
  while(url){
    statusEl.textContent=`Fetching ${tag}: page ${page}…`;
    let resp;
    try{ resp=await fetch(url); }catch(e){ throw {set:tag,query:q,status:'NETWORK',details:e?.message||String(e)}; }
    if(!resp.ok){ const text=await resp.text().catch(()=> ''); throw {set:tag,query:q,status:resp.status,details:text}; }
    const json=await resp.json();
    out = out.concat(json.data||[]);
    url = json.has_more ? json.next_page : null;
    page++; if(url) await sleep(120);
  }
  return out.filter(c=> (c.games||[]).includes('paper'));
}
async function fetchWithFallback(queries, tag, statusEl, errors){
  for(const q of queries){
    try{
      const data = await fetchAllPages(q, tag, statusEl);
      if(data.length) return {query:q, data};
    }catch(e){ errors.push(e); }
  }
  return {query:queries.join('  OR  '), data:[]};
}

/* ====================== Build ====================== */
async function build(){
  // reset UI
  const errorBox=document.getElementById('errorBox');
  errorBox.style.display='none';
  document.getElementById('status').textContent='Preparing…';
  document.getElementById('siftPanel').style.display='none';
  document.getElementById('siftTableWrap').style.display='none';
  document.getElementById('evPanel').style.display='none';
  document.getElementById('evOut').style.display='none';
  document.getElementById('siftBody').innerHTML='';
  document.getElementById('evBody').innerHTML='';
  __ROWS__=[]; __NORM_SCALE__=1;

  const englishOnly = document.getElementById('englishOnly').checked;
  const incOTJ = document.getElementById('includeOTJ').checked;
  const incOTP = document.getElementById('includeOTP').checked;
  const incBIG = document.getElementById('includeBIG').checked;
  const incSPG = document.getElementById('includeSPG').checked;
  const incTOK = document.getElementById('includeTOK').checked;
  const incART = document.getElementById('includeART').checked;
  const tokenFallback = parseUSD(document.getElementById('tokenFallback').value);
  const artFallback   = parseUSD(document.getElementById('artFallback').value);

  const status=document.getElementById('status');
  const errors=[]; const tried=[];

  try{
    // OTJ main (strict)
    let otj = [];
    if(incOTJ){
      const q = qOTJ_main(englishOnly); tried.push(`OTJ: ${q}`);
      try{ otj = await fetchAllPages(q,'OTJ',status); }catch(e){ errors.push(e); }
    }

    // OTP / BIG / SPG (with fallback)
    let otp=[], big=[], spg=[];
    if(incOTP){ const r=await fetchWithFallback(qOTP_try(englishOnly),'OTP',status,errors); tried.push(`OTP: ${r.query}`); otp=r.data; }
    if(incBIG){ const r=await fetchWithFallback(qBIG_try(englishOnly),'BIG',status,errors); tried.push(`BIG: ${r.query}`); big=r.data; }
    if(incSPG){ const r=await fetchWithFallback(qSPG_try(englishOnly),'SPG',status,errors); tried.push(`SPG: ${r.query}`); spg=r.data; }

    // Tokens & Art
    let tok=[], art=[];
    if(incTOK){ const q=qTOK(englishOnly); tried.push(`TOTJ: ${q}`); try{ tok=await fetchAllPages(q,'TOTJ tokens',status);}catch(e){ errors.push(e); } }
    if(incART){ const q=qART(englishOnly); tried.push(`AOTJ: ${q}`); try{ art=await fetchAllPages(q,'AOTJ art',status);}catch(e){ errors.push(e); } }

    // Partition OTJ
    const C = otj.filter(c=>c.rarity==='common');
    const U = otj.filter(c=>c.rarity==='uncommon');
    const R = otj.filter(c=>c.rarity==='rare');
    const M = otj.filter(c=>c.rarity==='mythic');

    const P = OTJ_ODDS;

    // Nonfoil per‑print (C/U + wildcard share)
    const cuTotal = (C.length + U.length) || 1;
    const wcCU = 1 - P.WILDCARD_RM;
    const wcCshare = wcCU * (C.length/cuTotal);
    const wcUshare = wcCU * (U.length/cuTotal);
    const pCommonNF   = C.length? (P.COMMON_SLOTS/C.length)  + (wcCshare/C.length) : 0;
    const pUncommonNF = U.length? (P.UNCOMMON_BASE/U.length) + (wcUshare/U.length) : 0;

    // Rare/mythic baseline + wildcard-to-R/M share
    const pRareNF     = R.length? ((P.RM_RARE_RATE)/R.length)     + ((P.WILDCARD_RM*P.RM_RARE_RATE)/R.length) : 0;
    const pMythicNF   = M.length? ((P.RM_MYTHIC_RATE)/M.length)   + ((P.WILDCARD_RM*P.RM_MYTHIC_RATE)/M.length) : 0;

    // Foil pools
    const foilC = C.filter(c=>(c.finishes||[]).includes('foil'));
    const foilU = U.filter(c=>(c.finishes||[]).includes('foil'));
    const foilR = R.filter(c=>(c.finishes||[]).includes('foil'));
    const foilM = M.filter(c=>(c.finishes||[]).includes('foil'));
    const pFoilC = foilC.length? P.FOIL_C/foilC.length : 0;
    const pFoilU = foilU.length? P.FOIL_U/foilU.length : 0;
    const pFoilR = foilR.length? P.FOIL_R/foilR.length : 0;
    const pFoilM = foilM.length? P.FOIL_M/foilM.length : 0;

    // Push helper
    function pushRow(card, treat, p, isNonGame=false, overrideUSD=null){
      const f = card.finishes||[];
      const price = (overrideUSD!==null)? overrideUSD : (treat==='foil'? parseUSD(card?.prices?.usd_foil) : parseUSD(card?.prices?.usd));
      __ROWS__.push({ name:card.name, treat, p, price, url:card.scryfall_uri||'', isNonGame });
    }

    // Add OTJ main
    for(const c of otj){
      const f = c.finishes||[];
      if(f.includes('nonfoil')){
        if(c.rarity==='common')   pushRow(c,'normal',pCommonNF);
        if(c.rarity==='uncommon') pushRow(c,'normal',pUncommonNF);
        if(c.rarity==='rare')     pushRow(c,'normal',pRareNF);
        if(c.rarity==='mythic')   pushRow(c,'normal',pMythicNF);
      }
      if(f.includes('foil')){
        if(c.rarity==='common')   pushRow(c,'foil',pFoilC);
        if(c.rarity==='uncommon') pushRow(c,'foil',pFoilU);
        if(c.rarity==='rare')     pushRow(c,'foil',pFoilR);
        if(c.rarity==='mythic')   pushRow(c,'foil',pFoilM);
      }
    }

    // OTP ~ 1 per pack across prints (include foil + nonfoil if present)
    if(otp.length){
      const perPrint = P.OTP_PER_PACK / otp.length;
      for(const c of otp){
        const f=c.finishes||[];
        if(f.includes('nonfoil')) pushRow(c,'normal',perPrint,false,null);
        if(f.includes('foil'))    pushRow(c,'foil',perPrint,false,null);
      }
    }

    // BIG ~ 20% of packs, nonfoil only
    if(big.length){
      const perPrint = P.BIG_PER_PACK / big.length;
      for(const c of big){
        const f=c.finishes||[];
        if(f.includes('nonfoil')) pushRow(c,'normal',perPrint,false,null);
      }
    }

    // SPG ~ 1/64 packs, nonfoil only
    if(spg.length){
      const perPrint = P.SPG_PER_PACK_NF / spg.length;
      for(const c of spg){
        const f=c.finishes||[];
        if(f.includes('nonfoil')) pushRow(c,'normal',perPrint,false,null);
      }
    }

    // Non‑game: tokens
    if(tok.length){
      const per = OTJ_ODDS.NONGAME_TOKEN / tok.length;
      for(const c of tok){
        const usd = parseUSD(c?.prices?.usd);
        const val = Number.isFinite(usd)? usd : parseUSD(document.getElementById('tokenFallback').value);
        pushRow(c,'token',per,true,val);
      }
    }
    // Non‑game: art (normal + signed)
    if(art.length){
      const n=art.length||1;
      const pNormal = OTJ_ODDS.NONGAME_ART / n;
      const pSigned = OTJ_ODDS.NONGAME_ART_SIGNED / n;
      for(const c of art){
        const usd = parseUSD(c?.prices?.usd);
        const val = Number.isFinite(usd)? usd : parseUSD(document.getElementById('artFallback').value);
        pushRow(c,'art',pNormal,true,val);
        pushRow(c,'signed',pSigned,true,val);
      