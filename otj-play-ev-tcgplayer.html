<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Outlaws of Thunder Junction — Play Booster EV</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  html {background-color:#0b0d10;}
  .eoe-app{
    --bg:#0b0d10; --fg:#e8ecf1; --muted:#a7b0bb; --acc:#6ac1ff;
    --card:#151a20; --ok:#1e7f3c; --err:#9b2c2c; --line:#222a33;
    --hi-bg:rgba(106,193,255,.14); --hi-line:#6ac1ff;
    --est-bg:rgba(106,193,255,.18); --est-line:#6ac1ff;
    min-height:100vh;background:var(--bg);color:var(--fg);
    font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    max-width:1120px;margin:32px auto;padding:0 16px;box-sizing:border-box;
  }
  .eoe-app a{color:var(--acc);text-decoration:underline}
  .eoe-app h1{font-size:22px;margin:0 0 12px}
  .eoe-app p.lede{color:var(--muted);margin:0 0 16px}
  .eoe-app .panel{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:16px;margin:16px 0}
  .eoe-app label{display:block;margin:4px 0}
  .eoe-app .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  .eoe-app input[type="number"],.eoe-app input[type="text"],.eoe-app select{
    width:12ch;background:#0e1216;color:#cfe3f5;border:1px solid #2a3541;border-radius:6px;padding:6px
  }
  .eoe-app input[type="number"]#costPerBox{width:14ch}
  .eoe-app select{width:auto}
  .eoe-app button{appearance:none;border:1px solid #2c3845;background:#1b232c;color:var(--fg);padding:10px 14px;border-radius:8px;cursor:pointer}
  .eoe-app button[disabled]{opacity:.5;cursor:default}
  .eoe-app .actions{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 0}
  .eoe-app #status{margin-top:8px;color:var(--muted)}
  .eoe-app #counts b{color:#7ddc7a}

  .freBanner{display:flex;justify-content:center;margin:8px 0 16px}
  .freBanner img{max-width:420px;width:100%;height:auto;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.35)}

  .btn-primary{border-color:var(--hi-line);background:linear-gradient(180deg,#203245,#1a2530);color:#dff1ff;font-weight:600}
  .hi-label{border:1px solid var(--hi-line);background:var(--hi-bg);border-radius:8px;padding:6px 8px}
  .hi-inline{display:flex;align-items:center;gap:6px;border:1px solid var(--hi-line);background:var(--hi-bg);border-radius:8px;padding:6px 8px}

  .error-panel{border-color:#ff7a7a!important}
  .error-panel h2{margin:0 0 8px;color:#ff7a7a;font-size:16px}
  .error-panel pre{white-space:pre-wrap;background:#0e1216;border:1px solid #2a3541;padding:8px;border-radius:6px;color:#ffd4d4}

  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border:1px solid #2a3541;padding:8px 10px;text-align:right}
  th:first-child,td:first-child{text-align:left}
  thead th{background:#0e1216;position:sticky;top:0;z-index:1}
  tbody tr:nth-child(even){background:#12171d}

  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2a3541}
  .pill.ok{background:rgba(30,127,60,.20);color:#dff3e3;border-color:#1e7f3c}
  .pill.bad{background:rgba(155,44,44,.16);color:#ffdede;border-color:#9b2c2c}

  .evbox table{margin:8px 0}
  .evbox table th,.evbox table td{border:1px solid #2a3541;padding:8px 10px}
  .evbox table thead th{background:#0e1216}
  .evbox table th:nth-child(3),
  .evbox table td:nth-child(3){
    background:var(--est-bg);
    border-color:var(--est-line);
    border-left-color:var(--est-line);
    color:#eaf6ff;
    font-weight:700;
  }
  .evbox table th:nth-child(2),
  .evbox table td:nth-child(2){border-right-color:var(--est-line)}

  .sift-ok  { background:rgba(30,127,60,.18) !important; border-left:2px solid #1e7f3c; }
  .sift-bad { background:rgba(155,44,44,.16) !important; border-left:2px solid #9b2c2c; }

  details.eoe-collapse>summary{
    cursor:pointer;list-style:none;display:flex;justify-content:space-between;align-items:center;
    padding:8px 10px;border:1px solid #2a3541;border-radius:8px;background:#0e1216;color:#dfeeff;font-weight:600
  }
  details.eoe-collapse>summary::-webkit-details-marker{display:none}
  details.eoe-collapse>summary::after{content:'▼';opacity:.8;transform:rotate(-90deg);transition:transform .18s;margin-left:12px;font-size:12px}
  details.eoe-collapse[open]>summary::after{transform:rotate(0deg)}
  details.eoe-collapse .content{margin-top:10px}

  /* Tiny debug log */
  #debugLog{font:12px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;color:#a7b0bb;background:#0e1216;border:1px dashed #2a3541;border-radius:8px;padding:8px;max-height:160px;overflow:auto}
</style>
</head>
<body>
<noscript>
  <div class="panel error-panel"><h2>JavaScript disabled</h2>
    <p>This page needs JavaScript to load Scryfall data. Please enable JS and reload.</p>
  </div>
</noscript>

<main class="eoe-app" aria-label="OTJ Play Booster EV app">
  <div class="freBanner">
    <a href="./index.html"><img src="freEV-banner.png" alt="FreEV — Spend your money on cards not calculators"></a>
  </div>

  <h1>Outlaws of Thunder Junction — Play Booster EV</h1>
  <p class="lede">
    Scryfall pricing on load. Playable cards renormalized to <b>14 cards/pack</b>.
    <br>OTP (Breaking News) modeled as a <b>dedicated 1/pack slot</b>; The List is <b>20% of packs</b> with <b>SPG = 1/64 packs</b>;
    non‑foil wildcard produces Rare/Mythic about <b>1/12</b> of the time (R:M ≈ 2:1). Foil slot share is divided across eligible prints.
  </p>

  <!-- Early debug surface -->
  <div class="panel" id="dbgPanel">
    <strong>Debug log</strong>
    <div id="debugLog">Booting…</div>
  </div>

  <div class="panel">
    <strong>Refresh data</strong>
    <label><input type="checkbox" id="englishOnly" checked> English‑only (avoid dupes)</label>

    <div class="row">
      <label><input type="checkbox" id="includeOTJ" checked> Include <b>OTJ</b> main set (normal + foil)</label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="includeOTP" checked> Include <b>OTP</b> Breaking News (normal only)</label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="includeSPG" checked> Include <b>SPG</b> Special Guests (normal only)</label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="includeBIG" checked> Include <b>BIG</b> The Big Score (The List)</label>
    </div>

    <div id="status" aria-live="polite" style="margin-top:6px">Preparing…</div>
    <div id="counts" style="margin-top:4px"></div>

    <div class="actions" style="margin-top:10px">
      <button id="buildBtn" class="btn-primary">Refresh List</button>
    </div>

    <details style="margin-top:8px">
      <summary>Advanced: Scryfall queries</summary>
      <pre id="queries" style="white-space:pre-wrap;"></pre>
    </details>
  </div>

  <div class="panel">
    <strong>Tokens (TOTJ)</strong>
    <div class="row">
      <label><input type="checkbox" id="includeTOK"> Include <b>TOTJ</b> Tokens</label>
      <label>Token fallback (USD): <input type="text" id="tokenFallback" value="0.05" title="Used if token price missing"></label>
    </div>
  </div>

  <div class="panel">
    <strong>Art Series (AOTJ)</strong>
    <div class="row">
      <label><input type="checkbox" id="includeART"> Include <b>AOTJ</b> Art Series (normal + signed)</label>
      <label>Art fallback (USD): <input type="text" id="artFallback" value="0.00" title="Used if art price missing"></label>
    </div>
  </div>

  <div id="purchasePanel" class="panel" style="display:none">
    <strong>Purchase EV Calculator</strong>
    <div class="row" style="margin-top:6px">
      <label class="hi-label">Boxes to buy: <input type="number" id="boxesToBuy" value="1" min="0" step="1"></label>
      <span class="hi-inline" title="Only count prints with Card Value ≥ this amount">
        <input type="checkbox" id="useSiftForEV" checked>
        <b>Use Sift (≥)</b>
        <input type="text" id="siftMin" value="0.25">
      </span>
      <label class="hi-label" title="Your buy price per 36-pack box">
        Cost per box (USD): <input type="number" id="costPerBox" value="0" min="0" step="0.01">
      </label>
    </div>
    <div class="row" style="margin-top:6px">
      <label>TCGplayer seller
        <select id="sellerTier" title="Fee policy for EV/fees">
          <option value="mkt-l1">Marketplace Seller Level 1</option>
          <option value="mkt-l2">Marketplace Seller Level 2</option>
          <option value="mkt-l3">Marketplace Seller Level 3</option>
          <option value="mkt-l4" selected>Marketplace Seller Level 4</option>
          <option value="pro">Pro Seller</option>
        </select>
      </label>
      <label class="hi-label" title="Order-level transaction fees">
        Expected transactions:
        <input type="number" id="expectedTx" value="0" min="0" step="1">
        <span style="color:var(--muted);font-size:12px;margin-left:6px">
          transaction % always applies; $0.30 × N uses this field. Leave 0 if you count it as shipping.
        </span>
      </label>
    </div>
    <div class="row" style="margin-top:6px">
      <label><input type="radio" name="rangeMode" value="stat" checked> Statistical range (CLT)</label>
      <label><input type="radio" name="rangeMode" value="struct"> Structural range (slot band)</label>
      <label>Confidence:
        <select id="confLevel">
          <option value="68">68% (~1σ)</option>
          <option value="90">90% (~1.645σ)</option>
          <option value="95" selected>95% (~1.96σ)</option>
          <option value="99">99% (~2.576σ)</option>
        </select>
      </label>
      <button id="calcEV" disabled>Calculate EV</button>
    </div>
    <div id="purchaseSummary" class="note"></div>
    <div id="purchaseEVContainer" class="evbox" style="display:none"></div>
    <div id="rangeNotes" class="note"></div>
  </div>

  <div id="siftPanel" class="panel" style="display:none">
    <strong>Row List (linked)</strong>
    <div class="row">
      <span class="pill ok">≥ threshold</span>
      <span class="pill bad">&lt; threshold</span>
      <button id="applySift" disabled>Re‑Apply Sift</button>
    </div>
    <div id="siftSummary" class="note" aria-live="polite"></div>
    <div class="sift-tablewrap" id="siftTableWrap" style="display:none">
      <table id="siftTable">
        <thead>
          <tr>
            <th>Set</th><th>No.</th><th>R</th><th>Name</th><th>Treatment</th>
            <th>Pack Prob Min (%)</th>
            <th>Card Value (USD)</th><th>Fees/card (USD)</th>
            <th>Expected cards per 1000</th>
          </tr>
        </thead>
        <tbody id="siftBody"></tbody>
      </table>
    </div>
    <div class="actions" id="dlRow" style="display:none">
      <button id="downloadCsv" disabled>Download CSV</button>
      <button id="downloadSiftCsv" disabled>Download Sift CSV</button>
    </div>
  </div>

  <div id="errorBox" class="panel error-panel" style="display:none">
    <h2>Load failed</h2>
    <div id="errorMsg"></div>
    <pre id="errorDetails"></pre>
  </div>

  <div id="totalsPanel" class="panel" style="display:none">
    <details id="totalsDetails" class="eoe-collapse" open>
      <summary>Totals (estimates)</summary>
      <div class="content">
        <table>
          <thead><tr><th>Metric</th><th>Across packs</th><th>Per 36‑pack box</th></tr></thead>
          <tbody id="totalsBody"></tbody>
        </table>
        <div id="totalsNotes" class="note"></div>
      </div>
    </details>
  </div>

  <div class="freBanner">
    <a href="./index.html"><img src="freEV-banner.png" alt="FreEV — Spend your money on cards not calculators"></a>
  </div>
</main>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LWMRXKNY5X"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){window.dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-LWMRXKNY5X');
</script>

<!-- Ultra-early error/log surface (ES5) -->
<script>
(function(){
  function log(msg){
    var el=document.getElementById('debugLog');
    if(el){ el.textContent += "\\n" + String(msg); el.scrollTop=el.scrollHeight; }
  }
  function showErrorEarly(title, detail){
    var box=document.getElementById('errorBox');
    var msg=document.getElementById('errorMsg');
    var det=document.getElementById('errorDetails');
    if(msg) msg.textContent = title || 'Error';
    if(det) det.textContent = detail || '';
    if(box){ box.style.display=''; box.scrollIntoView({behavior:'smooth',block:'start'}); }
    var st=document.getElementById('status'); if(st) st.textContent='Build failed.';
  }
  window.__frev_log = log;
  window.__frev_err = showErrorEarly;
  window.addEventListener('error', function(e){
    try{ showErrorEarly('Runtime error', (e.error&&e.error.stack)?e.error.stack:String(e.message||e)); }
    catch(_){}
  });
  window.addEventListener('unhandledrejection', function(e){
    try{ showErrorEarly('Unhandled promise rejection', String((e&&e.reason&&e.reason.message)||e.reason||'')); }
    catch(_){}
  });
  log('Early hooks installed');
})();
</script>

<!-- Main app (ES5-only syntax, robust backoff) -->
<script>
(function(){
  'use strict';
  var PACKS_PER_BOX = 36;
  var REQUEST_GAP_MS = 250;
  var MAX_RETRIES = 6;
  var __backoffUntil = 0;

  function $(id){ return document.getElementById(id); }
  function log(s){ if(window.__frev_log) window.__frev_log(s); }
  function isNum(n){ return typeof n === 'number' && isFinite(n); }
  function sleep(ms){ return new Promise(function(res){ setTimeout(res, ms); }); }
  function rarityLetter(r){ return r==='common'?'C':r==='uncommon'?'U':r==='rare'?'R':r==='mythic'?'M':(r?(r.charAt(0).toUpperCase()):''); }
  function padCollector(s){ s=String(s||''); var m=s.match(/^(\\d+)(.*)$/); return m? (m[1].padStart?m[1].padStart(4,'0'):('0000'+m[1]).slice(-4)) + (m[2]||'') : s; }
  function parseUSD(s){ var n=parseFloat(String(s).replace(/[^0-9.]/g,'')); return isNum(n)? n : null; }
  function money(n){ return isNum(n)? n.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) : ''; }
  function fmtUSD(n){ return money(n); }
  function fmtCount(n){
    if(!isNum(n)) return '';
    var d=Math.abs(n-Math.round(n));
    if(d<1e-9) return String(Math.round(n).toLocaleString());
    return n>=100? n.toFixed(1) : n>=10? n.toFixed(2) : n.toFixed(3);
  }
  function fmtInt(n){ return isNum(n)? String(Math.round(n).toLocaleString()) : ''; }
  function zFromConf(c){ c=Math.round(c); if(c>=99)return 2.576; if(c>=95)return 1.96; if(c>=90)return 1.645; if(c>=68)return 1.0; return 1.96; }
  function priceUSD(card, treat){
    var p = (treat==='foil' ? card && card.prices && card.prices.usd_foil : card && card.prices && card.prices.usd);
    var f = parseFloat(p); return isNum(f)? f : null;
  }

  // Fees
  function getSellerPolicy(){
    var sel = $('sellerTier'); var v = sel && sel.value ? sel.value : 'mkt-l4';
    var txPct = 0.025, txFixed = 0.30;
    if(v === 'pro') return { key:v, label:'Pro Seller', commission:0.0925, pro:0.025, txPct:txPct, txFixed:txFixed };
    return { key:v, label:'Marketplace Seller', commission:0.1025, pro:0, txPct:txPct, txFixed:txFixed };
  }
  function perCardFeeUSD(price, policy){
    if(!isNum(price) || price<=0) return 0;
    var preCap = price * (policy.commission + policy.pro);
    return Math.min(preCap, 50.0);
  }

  // Odds model (EVProject-aligned)
  var OTJ_ODDS = {
    COMMON_SLOTS: 6, UNCOMMON_BASE: 3, RARE_SLOT: 1, WILDCARD: 1,
    RM_MYTHIC_RATE: 1/7.4, RM_RARE_RATE: 1 - (1/7.4),
    WILDCARD_RM: 1/12, WILDCARD_R_SHARE: 2/3, WILDCARD_M_SHARE: 1/3,
    OTP_U: 2/3, OTP_RM: 1/3, OTP_R_SHARE: 2/3, OTP_M_SHARE: 1/3,
    LIST_RATE: 1/5, SPG_PER_PACK: 1/64,
    LAND_COMMON_DUALS: 1/2, LAND_WESTERN: 1/6, LAND_REGULAR: 1/3, LAND_FOIL_RATE: 0.20,
    FOIL_SLOT: 1.0, FOIL_RARITY: { common:0.70, uncommon:0.22, rare:0.07, mythic:0.01 },
    NONGAME_TOKEN: 0.65, NONGAME_ART: 0.30, NONGAME_ART_SIGNED: 0.05
  };

  // Probability model helper
  function PM_point(p){ return { type:'point', p:p }; }
  function probPoint(model){ return model && model.type==='point' ? model.p : null; }

  var __ROW_MODELS__ = [];
  var __META_ROWS__  = [];
  var __NORM_SCALE__ = 1;
  var __SIFT_CSV__   = '';
  var __CSV__        = '';

  function showError(title, err){
    var box = $('errorBox'), msg=$('errorMsg'), det=$('errorDetails'), st=$('status');
    if(msg) msg.textContent = title || 'Error';
    var detail = (err && err.stack) ? err.stack : (err && err.message ? err.message : String(err||'Unknown error'));
    if(det) det.textContent = detail;
    if(box){ box.style.display=''; box.scrollIntoView({behavior:'smooth', block:'start'}); }
    if(st) st.textContent='Build failed.';
    log('ERROR: ' + (title||'') + ' — ' + detail);
  }

  // Global capture (in case something throws later)
  window.addEventListener('error', function(e){ showError('Runtime error', e && (e.error||e.message||e)); });
  window.addEventListener('unhandledrejection', function(e){ showError('Unhandled promise rejection', e && (e.reason||e)); });

  // Scryfall backoff/throttle
  function nowMs(){ return (new Date()).getTime(); }
  function retryAfterSeconds(res, attempt){
    var ra = 0; try{ ra = parseInt(res.headers.get('Retry-After'),10); }catch(_){}
    if(!isNum(ra) || ra<=0) ra = Math.pow(2, Math.min(attempt, 6)); // sec
    return ra;
  }
  function waitForBackoff(){
    var n = nowMs(); if(__backoffUntil>n){ var wait = __backoffUntil-n; $('status').textContent='Respecting Retry-After… '+(wait/1000).toFixed(1)+'s'; return sleep(wait); }
    return Promise.resolve();
  }
  function fetchWithBackoff(url, attempt){
    attempt = attempt||1;
    return waitForBackoff().then(function(){
      return fetch(url, { cache:'no-store' }).then(function(r){
        if(r.status===429){
          var ra = retryAfterSeconds(r, attempt);
          __backoffUntil = nowMs() + ra*1000;
          if(attempt<MAX_RETRIES){
            $('status').textContent='Rate-limited (429). Retrying in '+ra+'s…';
            return sleep(ra*1000).then(function(){ return fetchWithBackoff(url, attempt+1); });
          }
          throw new Error('Scryfall 429 after retries');
        }
        if(!r.ok) throw new Error('HTTP '+r.status+' '+(r.statusText||''));
        return r.json();
      }).catch(function(e){
        if(attempt<MAX_RETRIES){
          var jitter = 300 + Math.random()*400;
          log('Fetch error, retrying: '+(e && e.message ? e.message : e)+' in '+jitter+'ms');
          return sleep(jitter).then(function(){ return fetchWithBackoff(url, attempt+1); });
        }
        throw e;
      }).then(function(j){
        return sleep(REQUEST_GAP_MS).then(function(){ return j; });
      });
    });
  }
  function fetchScryfallAll(url){
    return fetchWithBackoff(url,1).then(function(j){
      var all = (j && j.data && j.data.slice) ? j.data.slice() : [];
      var next = j && j.next_page;
      function loop(nextUrl){
        if(!nextUrl) return Promise.resolve(all);
        $('status').textContent='Fetching (page '+all.length+'+)…';
        return fetchWithBackoff(nextUrl,1).then(function(j2){
          if(j2 && j2.data && j2.data.length){ Array.prototype.push.apply(all, j2.data); }
          return loop(j2 && j2.next_page);
        });
      }
      return loop(next);
    });
  }

  function buildQuery(setCode, englishOnly){
    var q='';
    if(setCode==='OTJ') q='e:otj is:booster';
    if(setCode==='OTP') q='e:otp';
    if(setCode==='BIG') q='e:big';
    if(setCode==='SPG') q='e:spg';
    if(setCode==='TOTJ') q='e:totj';
    if(setCode==='AOTJ') q='e:aotj';
    if(englishOnly) q+=' lang:en';
    return q;
  }
  function linkOf(card){ return (card && card.scryfall_uri) ? card.scryfall_uri : ''; }

  function getSellerFeeSummary(packs, useSift, minUSD, policy){
    var gross=0, commPro=0, i, row, p, pS, usd, ok, expected;
    for(i=0;i<__ROW_MODELS__.length;i++){
      row=__ROW_MODELS__[i];
      p=probPoint(row.model); if(!isNum(p)) continue;
      pS = row.nonGame? p : (p*__